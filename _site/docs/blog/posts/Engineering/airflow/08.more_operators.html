<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kwangmin Kim">
<meta name="dcterms.date" content="2023-05-01">
<meta name="description" content="template">

<title>More Operators – Kwangmin Kim</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../../.././images/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Kwangmin Kim</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../docs/CV/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../docs/projects/index.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../../about.html"> 
<span class="menu-text">Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kmink3225"> <i class="bi bi-github" role="img" aria-label="Github">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/kwangmin-kim-a5241b200/"> <i class="bi bi-linkedin" role="img" aria-label="Linkedin">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">More Operators</h1>
<p class="subtitle lead">DAG Creation, Bash Operator, Task Performance Subject,</p>
  <div class="quarto-categories">
    <div class="quarto-category">Engineering</div>
  </div>
  </div>

<div>
  <div class="description">
    <p>template</p>
  </div>
</div>


<div class="quarto-title-meta column-page">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Kwangmin Kim </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 1, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<ul class="nav nav-pills" id="language-tab" role="tablist">
<li class="nav-item" role="presentation">
<button class="nav-link active" id="Korean-tab" data-bs-toggle="tab" data-bs-target="#Korean" type="button" role="tab" aria-controls="Korean" aria-selected="true">
Korean
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="English-tab" data-bs-toggle="tab" data-bs-target="#English" type="button" role="tab" aria-controls="knitr" aria-selected="false">
English
</button>
</li>
<div id="language-tabcontent" class="tab-content">
<div id="Korean" class="tab-pane fade show active" role="tabpanel" aria-labelledby="Korean-tab">
<div id="Korean" class="tab-pane fade show active" role="tabpanel" aria-labelledby="Korean-tab">
<section id="more-operators" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> More Operators</h1>
<table class="caption-top table">
<colgroup>
<col style="width: 32%">
<col style="width: 19%">
<col style="width: 9%">
<col style="width: 38%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">File Path</th>
<th style="text-align: left;">Operator (Class)</th>
<th>Importance</th>
<th style="text-align: left;">Note</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">airflow.models.bashoperator</td>
<td style="text-align: left;">BaseOperator</td>
<td>***</td>
<td style="text-align: left;">* base operator는 직접 쓰는게 아니라 user가 custom operator를 직접 개발하고싶은 경우 이 클래스를 상속하여 개발하기 위해 만든 operator (execute() 함수를 재정의(Override)하여 사용) <br> * 아래 오퍼레이터들은 모두 이 클래스를 상속하여 개발되어 있음 <br> * Airflow를 잘 쓰려면 이 오퍼레이터 상속/개발하는 것을 자유자재로 할 줄 알아야 함.</td>
</tr>
<tr class="even">
<td style="text-align: left;">airflow.operators.bash</td>
<td style="text-align: left;">BashOperator</td>
<td>***</td>
<td style="text-align: left;">* bash 쉘 스크립트를 실행 <br> * 가장 많이 사용하는 오퍼레이터 중 하나임</td>
</tr>
<tr class="odd">
<td style="text-align: left;">airflow.operators.branch</td>
<td style="text-align: left;">BaseBranchOperator</td>
<td>**</td>
<td style="text-align: left;">* 직접 사용할 수는 없음. <br> * 이 클래스를 상속하여 choose_branch 함수를 구현해야 함 (그냥 사용시 에러 발생) <br> * 그러나 이 클래스 상속해서 사용하는것보다 <span class="citation" data-cites="task.branch">@task.branch</span> 데코레이터 사용을 권장</td>
</tr>
<tr class="even">
<td style="text-align: left;">airflow.operators.datetime</td>
<td style="text-align: left;">BranchDateTimeOperator</td>
<td></td>
<td style="text-align: left;">* 특정 Datetime 구간을 주어 Job 수행 날짜가 구간에 속하는지 여부에 따라 분기 결정</td>
</tr>
<tr class="odd">
<td style="text-align: left;">airflow.operators.email</td>
<td style="text-align: left;">EmailOperator</td>
<td></td>
<td style="text-align: left;">이메일 전송하는 오퍼레이터 (Airflow 파라미터에 SMTP 서버 등 사전 셋팅 필요)</td>
</tr>
<tr class="even">
<td style="text-align: left;">airflow.operators.generic_transfer</td>
<td style="text-align: left;">GenericTransfer</td>
<td></td>
<td style="text-align: left;">데이터를 소스에서 타겟으로 전송 (Airflow 커넥션에 등록되어 있는 대상만 가능)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">airflow.operators.latest_only</td>
<td style="text-align: left;">LatestOnlyOperator</td>
<td></td>
<td style="text-align: left;">dag을 수행시킬 때 스케쥴이 아니라 backfill(과거 날짜로 dag 수행) 이 Task 뒤에 연결되어 있는 task들을 모두 가장 최근의 Job만 실행하게끔 하는 오퍼레이터. 수작업으로 job을 수행 시켰거나 과거날짜로 dag을 수행시켰을 때는 후행 task들은 돌아가지 않음. 가장 최근에 설정된 job에 의해서만 후행 task들이 돌아감.</td>
</tr>
<tr class="even">
<td style="text-align: left;">airflow.operators.subdag</td>
<td style="text-align: left;">SubDagOperator</td>
<td></td>
<td style="text-align: left;">* 일종의 task 그룹화, dag안에 또다른 dag을 불러올 수 있음. 해당 오퍼레이터 안에 다른 오퍼레이터를 둘 수 있음 (Task group과 유사)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">airflow.operators.trigger_dagrun</td>
<td style="text-align: left;">TriggerDagRunOperator</td>
<td>**</td>
<td style="text-align: left;">* 다른 DAG을 수행하기 위한 오퍼레이터. 예를 들어 task1에 의해 다른 dag이 수행되도록 설정할 수 있다.</td>
</tr>
<tr class="even">
<td style="text-align: left;">airflow.operators.weekday</td>
<td style="text-align: left;">BranchDayOfWeekOperator</td>
<td></td>
<td style="text-align: left;">* 특정 요일에 따라 분기처리할 수 있는 오퍼레이터</td>
</tr>
<tr class="odd">
<td style="text-align: left;">airflow.operators.python</td>
<td style="text-align: left;">PythonOperator</td>
<td>***</td>
<td style="text-align: left;">* 어떤 파이썬 함수를 실행시키기 위한 오퍼레이터</td>
</tr>
<tr class="even">
<td style="text-align: left;">airflow.operators.python</td>
<td style="text-align: left;">BranchPythonOperator</td>
<td>*</td>
<td style="text-align: left;">* 파이썬 함수 실행 결과에 따라 task를 선택적으로 실행시킬 때 사용되는 오퍼레이터</td>
</tr>
<tr class="odd">
<td style="text-align: left;">airflow.operators.python</td>
<td style="text-align: left;">ShortCircuitOperator</td>
<td></td>
<td style="text-align: left;">* 파이썬 함수 return 값이 False면 후행 Task를 Skip처리하고 dag을 종료시키는 오퍼레이터</td>
</tr>
<tr class="even">
<td style="text-align: left;">airflow.operators.python</td>
<td style="text-align: left;">PythonVirtualenvOperator</td>
<td></td>
<td style="text-align: left;">* 파이썬 가상환경 생성후 Job 수행하고 마무리되면 가상환경을 삭제해주는 오퍼레이터</td>
</tr>
<tr class="odd">
<td style="text-align: left;">airflow.operators.python</td>
<td style="text-align: left;">ExternalPythonOperator</td>
<td></td>
<td style="text-align: left;">* 기존에 존재하는 파이썬 가상환경에서 Job 수행하게 하는 오퍼레이터</td>
</tr>
</tbody>
</table>
<ul>
<li><p><a href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/operators/index.html">more oeprators-airflow operators</a> ## Provider Operator</p></li>
<li><p>airflow web service &gt;&gt; Admin &gt;&gt; Providers 에서 확인할 수 있음</p></li>
<li><p>solution 제공 업체에서 본인들의 solution을 잘 다루게 하기 위해 만든 airflow에 제공한 operator</p></li>
<li><p>솔루션 제공 업체: AWS, GCP, MS Azure 등</p></li>
<li><p>예를 들어, airflow web service &gt;&gt; Admin &gt;&gt; Providers &gt;&gt; apache-airflow-providers-amazon &gt;&gt; Python API &gt;&gt; [airflow.providers.amazon.aws.hooks, airflow.providers.amazon.aws.operators]</p></li>
<li><p>참고로 airflow는 GCP와 궁합이 잘맞음</p></li>
</ul>
</section>
<section id="triggerdagrun-operator" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> TriggerDagRun Operator</h1>
<section id="dag간-의존관계-설정" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="dag간-의존관계-설정"><span class="header-section-number">2.1</span> DAG간 의존관계 설정</h2>
<ul>
<li>의존 관계 : dag간 선 후행 관계</li>
<li>DAG 의존관계 설정 방법
<ol type="1">
<li>TriggerDagRun Operator</li>
</ol></li>
</ul>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 184.00 209.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 205)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-205 180,-205 180,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster0</title>
<polygon fill="none" stroke="black" points="8,-8 8,-193 168,-193 168,-8 8,-8"></polygon>
<text text-anchor="middle" x="88" y="-176.4" font-family="Times,serif" font-size="14.00">Task Flow</text>
</g>
<!-- task1 -->
<g id="node1" class="node">
<title>task1</title>
<polygon fill="none" stroke="black" points="70,-106 16,-106 16,-70 70,-70 70,-106"></polygon>
<text text-anchor="middle" x="43" y="-83.8" font-family="Times,serif" font-size="14.00">task1</text>
</g>
<!-- task2 -->
<g id="node2" class="node">
<title>task2</title>
<polygon fill="none" stroke="black" points="160,-52 106,-52 106,-16 160,-16 160,-52"></polygon>
<text text-anchor="middle" x="133" y="-29.8" font-family="Times,serif" font-size="14.00">task2</text>
</g>
<!-- task1&#45;&gt;task2 -->
<g id="edge1" class="edge">
<title>task1-&gt;task2</title>
<path fill="none" stroke="black" d="M70.4,-71.8C78.83,-66.63 88.29,-60.82 97.22,-55.34"></path>
<polygon fill="black" stroke="black" points="99.23,-58.22 105.92,-50 95.57,-52.25 99.23,-58.22"></polygon>
</g>
<!-- task3 -->
<g id="node3" class="node">
<title>task3</title>
<polygon fill="none" stroke="black" points="160,-106 106,-106 106,-70 160,-70 160,-106"></polygon>
<text text-anchor="middle" x="133" y="-83.8" font-family="Times,serif" font-size="14.00">task3</text>
</g>
<!-- task1&#45;&gt;task3 -->
<g id="edge2" class="edge">
<title>task1-&gt;task3</title>
<path fill="none" stroke="black" d="M70.4,-88C78.39,-88 87.31,-88 95.82,-88"></path>
<polygon fill="black" stroke="black" points="95.92,-91.5 105.92,-88 95.92,-84.5 95.92,-91.5"></polygon>
</g>
<!-- task4 -->
<g id="node4" class="node">
<title>task4</title>
<polygon fill="none" stroke="black" points="160,-160 106,-160 106,-124 160,-124 160,-160"></polygon>
<text text-anchor="middle" x="133" y="-137.8" font-family="Times,serif" font-size="14.00">task4</text>
</g>
<!-- task1&#45;&gt;task4 -->
<g id="edge3" class="edge">
<title>task1-&gt;task4</title>
<path fill="none" stroke="black" d="M70.4,-104.2C78.83,-109.37 88.29,-115.18 97.22,-120.66"></path>
<polygon fill="black" stroke="black" points="95.57,-123.75 105.92,-126 99.23,-117.78 95.57,-123.75"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li>task를 만들 때 task내에 dag_id를 명시하는 parameter가 있음</li>
<li>task1: PythonOperator 등</li>
<li>task2,3,4: TriggerDagRun 오퍼레이터로 다른 DAG 을 실행시키는 오퍼레이터</li>
</ul>
<ol start="2" type="1">
<li>ExternalTask Sensor</li>
</ol>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 181.61 263.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 259)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-259 177.61,-259 177.61,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster0</title>
<polygon fill="none" stroke="black" points="8,-8 8,-247 82.77,-247 82.77,-8 8,-8"></polygon>
<text text-anchor="middle" x="45.39" y="-230.4" font-family="Times,serif" font-size="14.00">Task Flow</text>
</g>
<!-- sensor1 -->
<g id="node1" class="node">
<title>sensor1</title>
<polygon fill="none" stroke="black" points="74.66,-214 16.11,-214 16.11,-178 74.66,-178 74.66,-214"></polygon>
<text text-anchor="middle" x="45.39" y="-191.8" font-family="Times,serif" font-size="14.00">sensor1</text>
</g>
<!-- task1 -->
<g id="node5" class="node">
<title>task1</title>
<ellipse fill="none" stroke="black" cx="142.19" cy="-115" rx="31.34" ry="18"></ellipse>
<text text-anchor="middle" x="142.19" y="-110.8" font-family="Times,serif" font-size="14.00">task1</text>
</g>
<!-- sensor1&#45;&gt;task1 -->
<g id="edge1" class="edge">
<title>sensor1-&gt;task1</title>
<path fill="none" stroke="black" d="M71.71,-177.76C75.47,-174.89 79.26,-171.91 82.77,-169 94.63,-159.17 107.25,-147.65 117.72,-137.78"></path>
<polygon fill="black" stroke="black" points="120.42,-140.04 125.25,-130.61 115.59,-134.97 120.42,-140.04"></polygon>
</g>
<!-- sensor2 -->
<g id="node2" class="node">
<title>sensor2</title>
<polygon fill="none" stroke="black" points="74.66,-160 16.11,-160 16.11,-124 74.66,-124 74.66,-160"></polygon>
<text text-anchor="middle" x="45.39" y="-137.8" font-family="Times,serif" font-size="14.00">sensor2</text>
</g>
<!-- sensor2&#45;&gt;task1 -->
<g id="edge2" class="edge">
<title>sensor2-&gt;task1</title>
<path fill="none" stroke="black" d="M74.83,-133.9C83.98,-131.29 94.26,-128.37 103.94,-125.61"></path>
<polygon fill="black" stroke="black" points="105.09,-128.92 113.75,-122.82 103.17,-122.19 105.09,-128.92"></polygon>
</g>
<!-- sensor3 -->
<g id="node3" class="node">
<title>sensor3</title>
<polygon fill="none" stroke="black" points="74.66,-106 16.11,-106 16.11,-70 74.66,-70 74.66,-106"></polygon>
<text text-anchor="middle" x="45.39" y="-83.8" font-family="Times,serif" font-size="14.00">sensor3</text>
</g>
<!-- sensor3&#45;&gt;task1 -->
<g id="edge3" class="edge">
<title>sensor3-&gt;task1</title>
<path fill="none" stroke="black" d="M74.83,-96.1C83.98,-98.71 94.26,-101.63 103.94,-104.39"></path>
<polygon fill="black" stroke="black" points="103.17,-107.81 113.75,-107.18 105.09,-101.08 103.17,-107.81"></polygon>
</g>
<!-- sensor4 -->
<g id="node4" class="node">
<title>sensor4</title>
<polygon fill="none" stroke="black" points="74.66,-52 16.11,-52 16.11,-16 74.66,-16 74.66,-52"></polygon>
<text text-anchor="middle" x="45.39" y="-29.8" font-family="Times,serif" font-size="14.00">sensor4</text>
</g>
<!-- sensor4&#45;&gt;task1 -->
<g id="edge4" class="edge">
<title>sensor4-&gt;task1</title>
<path fill="none" stroke="black" d="M71.71,-52.24C75.47,-55.11 79.26,-58.09 82.77,-61 94.63,-70.83 107.25,-82.35 117.72,-92.22"></path>
<polygon fill="black" stroke="black" points="115.59,-95.03 125.25,-99.39 120.42,-89.96 115.59,-95.03"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li>sensor를 통해 task를 만들기 때문에 여기서 sensor는 task를 의미함</li>
<li>sensor를 만들 때도 감지해야할 dag_id를 명시해줘야함 (task_id도 명시 가능)</li>
<li>ExternalTask Sensor는 다른 여러 DAGs의 Task의 완료를 기다리는 센서</li>
<li>DAG간 의존관계 설정
<ul>
<li>방식
<ul>
<li>TriggerDagRun Operator: 실행할 다른 DAG 의 ID 를 지정하여 수행</li>
<li>ExternalTask 센서: 본 Task 가 수행되기 전 다른 DAG 의 완료를 기다린 후 수행</li>
</ul></li>
<li>권고 사용 시점
<ul>
<li>TriggerDagRun Operator: Trigger 되는 DAG 의 선행 DAG 이 <strong>하나</strong>만 있을 경우</li>
<li>ExternalTask 센서: Trigger 되는 DAG 의 선행 DAG 이 <strong>2 개 이상</strong>인 경우</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="triggerdagrun-오퍼레이터" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="triggerdagrun-오퍼레이터"><span class="header-section-number">2.2</span> TriggerDagRun 오퍼레이터</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>from airflow.operators.trigger_dagrun import TriggerDagRunOperator</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>with DAG(...) as dag:</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="in">    start_task = BashOperator(</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='start_task',</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='echo "start!"',</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="in">    trigger_dag_task = TriggerDagRunOperator(</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='trigger_dag_task', #필수값</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="in">        trigger_dag_id='dags_python_operator', #필수값</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="in">        trigger_run_id=None,</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="in">        execution_date='{{data_interval_start}}',</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="in">        reset_dag_run=True,</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="in">        wait_for_completion=False,</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="in">        poke_interval=60,</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="in">        allowed_states=['success'],</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="in">        failed_states=None</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="in">        )</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="in">    start_task &gt;&gt; trigger_dag_task</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="triggerdagrun-오퍼레이터-의-run_id" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="triggerdagrun-오퍼레이터-의-run_id"><span class="header-section-number">2.3</span> TriggerDagRun 오퍼레이터 의 run_id</h2>
<ul>
<li>run_id: DAG의 수행 방식과 시간을 유일하게 식별해주는 키</li>
<li>같은 시간이라 해도 수행 방식 (Schedule, manual, Backfill) 에 따라 키가 달라짐
<ul>
<li>스케쥴: 스케줄에 의해 실행된 경우 scheduled__{{data_interval_start}} 값을 가짐</li>
<li>manual: airflow ui web에서 수작업 수행. manual__{{data_interval_start}} 값을 가짐
<ul>
<li>manual__{{data_interval_start}}은 수작업 수행 시간이 아니라 수잦업으로 실행시킨 스케쥴의 구간값 중 data_interval_start값을 의미</li>
</ul></li>
<li>Backfill: 과거 날짜를 이용해 수행. backfill__{{data_interval_start}} 값을 가짐</li>
</ul></li>
<li>run_id를 보는 방법
<ul>
<li>airflow ui web &gt;&gt; dag &gt;&gt; grid &gt;&gt; 초록색 긴막대기 &gt;&gt; status Run ID 있음</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>from airflow.operators.trigger_dagrun import TriggerDagRunOperator</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>with DAG(...) as dag:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="in">    start_task = BashOperator(</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='start_task',</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='echo "start!"',</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="in">    trigger_dag_task = TriggerDagRunOperator(</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='trigger_dag_task', </span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="in">        trigger_dag_id='dags_python_operator',</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="in">        trigger_run_id=None, # rund_id 값 직접 지정</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="in">        execution_date='{{data_interval_start}}', # manual_{{execution_date}} 로 수행</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="in">        reset_dag_run=True, # 이미 run_id 값이 있는 경우에도 재수행할 것 인지 결정. True면 재수행</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="in">        wait_for_completion=False,</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="in">        poke_interval=60,</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="in">        allowed_states=['success'],</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="in">        failed_states=None</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="in">        )</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="in">    start_task &gt;&gt; trigger_dag_task</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>wait_for_completion:</li>
</ul>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 466.59 155.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 151)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-151 462.59,-151 462.59,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster0</title>
<polygon fill="none" stroke="black" points="90.84,-8 90.84,-139 450.59,-139 450.59,-8 90.84,-8"></polygon>
<text text-anchor="middle" x="270.71" y="-122.4" font-family="Times,serif" font-size="14.00">Task Flow</text>
</g>
<!-- task1 -->
<g id="node1" class="node">
<title>task1</title>
<polygon fill="none" stroke="black" points="152.84,-106 98.84,-106 98.84,-70 152.84,-70 152.84,-106"></polygon>
<text text-anchor="middle" x="125.84" y="-83.8" font-family="Times,serif" font-size="14.00">task1</text>
</g>
<!-- task2_by_trigger_dag_run -->
<g id="node2" class="node">
<title>task2_by_trigger_dag_run</title>
<polygon fill="none" stroke="black" points="352.46,-106 188.97,-106 188.97,-70 352.46,-70 352.46,-106"></polygon>
<text text-anchor="middle" x="270.71" y="-83.8" font-family="Times,serif" font-size="14.00">task2_by_trigger_dag_run</text>
</g>
<!-- task1&#45;&gt;task2_by_trigger_dag_run -->
<g id="edge1" class="edge">
<title>task1-&gt;task2_by_trigger_dag_run</title>
<path fill="none" stroke="black" d="M153.05,-88C160.62,-88 169.34,-88 178.54,-88"></path>
<polygon fill="black" stroke="black" points="178.68,-91.5 188.68,-88 178.68,-84.5 178.68,-91.5"></polygon>
</g>
<!-- task3 -->
<g id="node3" class="node">
<title>task3</title>
<polygon fill="none" stroke="black" points="442.59,-106 388.59,-106 388.59,-70 442.59,-70 442.59,-106"></polygon>
<text text-anchor="middle" x="415.59" y="-83.8" font-family="Times,serif" font-size="14.00">task3</text>
</g>
<!-- task2_by_trigger_dag_run&#45;&gt;task3 -->
<g id="edge2" class="edge">
<title>task2_by_trigger_dag_run-&gt;task3</title>
<path fill="none" stroke="black" d="M352.75,-88C361.58,-88 370.22,-88 378.1,-88"></path>
<polygon fill="black" stroke="black" points="378.33,-91.5 388.33,-88 378.33,-84.5 378.33,-91.5"></polygon>
</g>
<!-- dag_c -->
<g id="node4" class="node">
<title>dag_c</title>
<polygon fill="none" stroke="black" points="152.84,-52 98.84,-52 98.84,-16 152.84,-16 152.84,-52"></polygon>
<text text-anchor="middle" x="125.84" y="-29.8" font-family="Times,serif" font-size="14.00">dag_c</text>
</g>
<!-- task2 -->
<g id="node5" class="node">
<title>task2</title>
<ellipse fill="none" stroke="black" cx="31.42" cy="-34" rx="31.34" ry="18"></ellipse>
<text text-anchor="middle" x="31.42" y="-29.8" font-family="Times,serif" font-size="14.00">task2</text>
</g>
<!-- task2&#45;&gt;dag_c -->
<g id="edge3" class="edge">
<title>task2-&gt;dag_c</title>
<path fill="none" stroke="black" d="M62.94,-34C71.16,-34 80.14,-34 88.64,-34"></path>
<polygon fill="black" stroke="black" points="88.69,-37.5 98.69,-34 88.69,-30.5 88.69,-37.5"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li>wait_for_completion=True 의 의미: task2가 dag_c를 돌리고 dag_c가 성공한 상태 후 task2역시 성공 상태가 된 후에 task3을 돌리는 경우</li>
<li>wait_for_completion=False 의 의미: dag_c의 성공여부와 상관없이 task2가 성공 상태로 빠져나옴</li>
<li>poke_interval=60 : dag_c의 성공여부를 모니터링 하는 주기 60초</li>
<li>allowed_states=[‘success’]: trigger dag의 task2가 성공상태로 끝나기 위해 dag_c가 어떤 상태로 수행이 끝나야하는지 명시. 만약 dag_c가 fail상태여도 task2가 성공 상태로 마킹이 되길 원한다면 allowed_states=[‘success’,‘fail’] 로 명시</li>
<li>failed_states=None: task2가 실패 상태로 마킹이 되기 위해 dag_c가 어떤 상태로 작업 수행이 완료 되어야 하는지 명시. failed_states=fail이면 dag_c가 실패가 되어야 task2도 실패로 마킹 된다.</li>
<li>Dag Full example</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Package Import</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>from airflow import DAG</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>from airflow.operators.bash import BashOperator</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>from airflow.operators.trigger_dagrun import TriggerDagRunOperator</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>import pendulum</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>with DAG(</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    dag_id='dags_trigger_dag_run_operator',</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    start_date=pendulum.datetime(2023,4,1, tz='Asia/Seoul'),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    schedule='30 9 * * *', #9시 30분 daily schedule</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    catchup=False</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>) as dag:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="in">    start_task = BashOperator(</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='start_task',</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='echo "start!"',</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="in">    trigger_dag_task = TriggerDagRunOperator(</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='trigger_dag_task',</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="in">        trigger_dag_id='dags_python_operator',</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="in">        trigger_run_id=None,</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="in">        execution_date='{{data_interval_start}}', #9시 30분 daily schedule</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="in">        reset_dag_run=True,</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="in">        wait_for_completion=False,</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="in">        poke_interval=60,</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="in">        allowed_states=['success'],</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="in">        failed_states=None</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="in">        )</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="in">    start_task &gt;&gt; trigger_dag_task</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="simplehttp-오퍼레이터-서울시-공공데이터-키-발급받기" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> SimpleHttp 오퍼레이터 서울시 공공데이터 키 발급받기</h1>
<section id="서울시-공공데이터-보기" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="서울시-공공데이터-보기"><span class="header-section-number">3.1</span> 서울시 공공데이터 보기</h2>
<ul>
<li><a href="https://data.seoul.go.kr/">서울시 열린데이터 광장 portal</a></li>
<li>서울시가 보유한 데이터 다운로드 가능</li>
<li>일회성 다운로드 : Csv, json, xml 등을 직접 다운로드</li>
<li>스케쥴에 의한 주기성 다운로드 : openAPI(http method를 통해 data를 다운로드 할 수 있도록 개방해놓은 API) 통해 다운 가능</li>
<li>openAPI 이용할 경우 api KEY 발급받아야 함 로그인 필요
<ul>
<li>로그인 &gt;&gt; 이용 안내 &gt;&gt; open API 소개 &gt;&gt; 일반 인증키 신청 or 실시간 지하철 인증키 신청</li>
<li>sheet는 최대 1,000건 (행) 까지 노출됨. 전체 데이터는 CSV파일을 내려받아 확인해야함.</li>
<li>url 양식: http://openapi.seoul.go.kr:8088/(key:인증키)/(type)/(servicec)/(type)/(start_index)/(end_index)/(main_key 혹은 날짜)</li>
</ul></li>
<li>예시: 서울시 자랑스러운 한국음식점 정보 (한국어)
<ul>
<li>샘플 URL: http://openapi.seoul.go.kr:8088/(인증키)/xml/SebcKoreanRestaurantsKor/1/5</li>
</ul></li>
</ul>
</section>
<section id="api-사용을-위한-키-발급-받기" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="api-사용을-위한-키-발급-받기"><span class="header-section-number">3.2</span> API 사용을 위한 키 발급 받기</h2>
</section>
</section>
<section id="simplehttp-오퍼레이터-api-받아오기" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> SimpleHttp 오퍼레이터 API 받아오기</h1>
<section id="simplehttpoperator-란" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="simplehttpoperator-란"><span class="header-section-number">4.1</span> SimpleHttpOperator 란?</h2>
<ul>
<li>HTTP 요청을 하고 결과로 text 를 리턴 받는 오퍼레이터 리턴 값은 Xcom 에 저장</li>
<li>HTTP 를 이용하여 API 를 처리하는 RestAPI 호출시 사용 가능
<ul>
<li>RestAPI: API 방법 중 하나로 http의 protocol을 이용해서 API data를 제공하거나, 다운로드, 변경할 수 있는 API를 제공하는 방식</li>
<li>SimpleHttpOperator를 이용해서 RestAPI를 호출</li>
<li>http://localhost:8080/provider/apache-airflow-providers-http 에서 <a href="https://airflow.apache.org/docs/apache-airflow-providers-http/4.3.0/">오퍼레이터 명세 확인하기</a></li>
<li><a href="https://airflow.apache.org/docs/apache-airflow-providers-http/4.3.0/_api/airflow/providers/http/index.html">python API click</a>
<ul>
<li><a href="https://airflow.apache.org/docs/apache-airflow-providers-http/4.3.0/_api/airflow/providers/http/operators/http/index.html">http Operator click</a> 의 자주 쓰는 parameters
<ul>
<li>http_conn_id (str) – The http connection to run the operator against: full url의 ’<strong><sub>.com<strong>/나머지’ 의 </strong></sub>.com</strong> 을 넣어줌</li>
<li>endpoint (str | None) – The relative part of the full url. (templated): full url의 ‘~.com/<strong>나머지</strong>’ 의 <strong>나머지</strong>를 넣어줌</li>
<li>method (str) – The HTTP method to use, default = “POST”: http의 4개 methods
<ul>
<li>GET: data 가져오기</li>
<li>POST: data insert</li>
<li>PUT: data 변경/update</li>
<li>DELETE: data 삭제하기</li>
</ul></li>
<li>data (Any) – The data to pass. POST-data in POST/PUT and params in the URL for a GET request. (templated)
<ul>
<li>POST의 경우: insert할 data 값</li>
<li>GET의 경우: HTTP Protocol을 GET으로 줬으면 GET요청의 parameter를 dictionary 형태로 입력해주면 됨</li>
</ul></li>
<li>headers (dict[str, str] | None) – The HTTP headers to be added to the GET request</li>
<li>response_check (Callable[…, bool] | None) – A check against the ‘requests’ response object. The callable takes the response object as the first positional argument and optionally any number of keyword arguments available in the context dictionary. It should return True for ‘pass’ and False otherwise.
<ul>
<li>data 요청시 응답이 제대로 왔는지 확인</li>
<li>data를 일회성으로 가져올 때 데이터 1000 행이 제대로 들어왔는지 간단한 조회로 알아볼 수 있지만</li>
<li>data를 open API를 이용하여 주기적으로 내려받는 자동화의 경우 일일히 확인하는게 아니라 데이터가 잘 내려 받았는지 확인하는 함수를 하나 만들어 이 parameter에 할당하면 됨.</li>
<li>true로 resturn하면 API가 정상적으로 실행된 것으로 간주</li>
</ul></li>
<li>response_filter (Callable[…, Any] | None) – A function allowing you to manipulate the response text. e.g response_filter=lambda response: json.loads(response.text). The callable takes the response object as the first positional argument and optionally any number of keyword arguments available in the context dictionary.
<ul>
<li>API의 요청 결과가 dictionary 형태의 string으로 출력됨. 나중에 dictionary type으로 바꿔주고 key: value 형태로 access하여 원하는 데이터를 가져 와야 한다.</li>
<li>이런 전처리 과정을 수행하는 함수를 만들어 reponse_filter parameter에 넣어줘야함.</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="커넥션-등록" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="커넥션-등록"><span class="header-section-number">4.2</span> 커넥션 등록</h2>
<ul>
<li>http_conn_id에 들어갈 connection id 만들기
<ul>
<li>airflow web service &gt;&gt; Admin &gt;&gt; Plus button</li>
<li>Conn_id: 다른 conn 이름과 중복되지 않게 string으로 작성</li>
</ul></li>
<li>Connection_type: HTTP</li>
<li>Host: openapi.seoul.go.kr</li>
<li>token값에 의해 인증되는 방식이기 때문에 schema/login/password 필요없음</li>
<li>Port: 8088</li>
<li>Test 버튼 클릭시 “405:Method Not Allowed” 가 뜨지만 무방함</li>
</ul>
</section>
<section id="simplehttpoperator-작성" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="simplehttpoperator-작성"><span class="header-section-number">4.3</span> SimpleHttpOperator 작성</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>from airflow.providers.http.operators.http import SimpleHttpOperator</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>with DAG(...) as dag:</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  tb_cycle_station_info = SimpleHttpOperator(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    task_id ='tb_cycle_station_info',</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    http_conn_id = 'openapi.seoul.go.kr',</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    endpoint ='{{var.value.apikey_openpai_seoul_go_kr}}/json/SebcKoreanRestaurantsKor/1/1000/',</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    method ='GET',</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    headers ={'Content-Type: 'application/json',</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>              charset': 'utf-8',</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>              'Accept': '*/*'</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="dag에-실제-api-key값을-작성하면-문제가-되는-이슈" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="dag에-실제-api-key값을-작성하면-문제가-되는-이슈"><span class="header-section-number">4.3.1</span> DAG에 실제 API key값을 작성하면 문제가 되는 이슈</h3>
<ul>
<li>SimpleHttpOperator를 1000개의 DAGs 에 작성했는데 API 키가 바뀐다면?</li>
<li>DAG에다가 바로 인증키를 복붙하면 다른 사람들도 API키를 볼 수 있어 보안상의 문제가 될 수 있다.</li>
<li>위의 2가지 문제를 해결하기 위해 global variable을 이용하여 적을 것.
<ul>
<li>API key를 variable을 이용하여 등록: airflow web service &gt;&gt; admin &gt;&gt; Variables
<ul>
<li>key:value형태로 등록 가능</li>
<li>관리자가 DB에 들어가면 API Key값 볼 수 있음</li>
</ul></li>
</ul></li>
<li>Key에 아래 이름이 있을 경우 val 을 자동 마스킹처리하여 보여줌
<ul>
<li>‘access_token’,</li>
<li>‘api_key’,</li>
<li>‘apikey’,</li>
<li>‘authorization’,</li>
<li>‘passphrase’,</li>
<li>‘passwd’,</li>
<li>‘password’,</li>
<li>‘private_key’,</li>
<li>‘secret’,</li>
<li>‘token’</li>
</ul></li>
<li>global variable 설정하면
<ul>
<li>서울시 공공데이터 추출하는 DAG 이 여러 개 있어도 API 키를 하나로 관리 가능</li>
<li>API 키를 코드에 노출시키지 않음</li>
</ul></li>
</ul>
</section>
</section>
</section>
<section id="custom-오퍼레이터-만드는-방법" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Custom 오퍼레이터 만드는 방법</h1>
<section id="airflow-의-꽃-custom-오퍼레이터" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="airflow-의-꽃-custom-오퍼레이터"><span class="header-section-number">5.1</span> Airflow 의 꽃 , Custom 오퍼레이터</h2>
<ul>
<li>Airflow는 오퍼레이터를 직접 만들어 사용할 수 있도록 클래스를 제공 (BaseOperator)</li>
<li>확장성을 비약적으로 높여주는 기능으로 airflow가 인기가 많은 이유가 됨</li>
<li>BaseOperator 상속한 자식 operator가 custom operator가 됨</li>
<li>BaseOperator 상속시 두 가지 메서드를 재정의해야 함 (Overriding)
<ul>
<li>Overriding: 객체 지향 언어에서 부모 클래스가 가지고있던 method를 자식 class에서 재정의</li>
</ul>
<ol type="1">
<li>생성자 재정의: def__init__</li>
</ol>
<ul>
<li>클래스에서 객체 생성시 객체에 대한 초기값 지정하는 함수</li>
</ul>
<ol start="2" type="1">
<li>def execute(self, context) (자식 클래스에서 똑같은 이름으로 써야함)</li>
</ol>
<ul>
<li><strong>init</strong> 생성자로 객체를 얻은 후 execute 메서드를 실행시키도록 되어 있음</li>
<li>비즈니스 로직은 execute 에 구현 필요</li>
</ul></li>
<li>오퍼레이터 기능 정의
<ul>
<li>기존에 있던 operator들로 job을 수행하기에 제한적이었던 점을 보완할 기능을 정의해야함
<ul>
<li>simpleHttpOperator에서 불편했던 점은 매번 endpoint에 시작행/끝행을 넣어서 호출 해줘야 했는데 이것을 1000행씩 불러오도록 하는 기능이 필요</li>
<li>xcom에서 data를 가지고 온후 data에 접근할 수 있는 형태로 전처리를 해줘야하는 부분이 있었는데 전처리없이 local에다가 바로 저장할 수 있도록 하는 기능이 필요</li>
</ul></li>
<li>서울시 공공데이터 API 를 호출하여 전체 데이터를 받은 후 .csv 파일로 저장하기</li>
</ul></li>
<li>오퍼레이터와 dag 의 위치
<ul>
<li><p>/dags/dags_seoul_api.py 생성</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>from operators.seoul_api_to_csv_operator</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>import SeoulApiToCsvOperator</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>/plugins/operators/seoul_api_to_csv_operator.py 생성</p></li>
</ul></li>
<li>Template 문법을 사용할 수 있는 Template을 지정 (사용 가능한 파라미터 지정하기)</li>
<li>아래의 HelloOperator는 __init__과 execute(self, context) 둘다 재정의 해줬기 때문에 코드상으론 심플하지만 이미 custom operator로서의 기능을 할 수 있다.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>class HelloOperator(BaseOperator):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  template_fields: Sequence<span class="co">[</span><span class="ot">str</span><span class="co">]</span> = ("name",) # 이 line 어떤 parameter에 template 문법을 적용할지 지정해주면 됨</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  # 생성자 함수 __init__ 의 member들로 template 문법을 적용할 paratemer 지정</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  def __init__(self, name: str, world: str, **kwargs) -&gt; None:</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    super().__init__(**kwargs)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    self.name = name</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    self.world =world</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  def execute(self, context):</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    message = f"Hello {self.world} it's {self.name}!"</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    print(message)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    return message</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>with dag:</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  hello_task = HelloOperator(</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    task_id='task_id_1',</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    name '{{ task_instance.task_id }}',</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    world='Earth'</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><a href="https://airflow.apache.org/docs/apache-airflow/stable/howto/custom-operator.html">Google Airflow Custom Operator</a></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../../../../images/airflow/custom_operator.PNG" class="img-fluid figure-img"></p>
<figcaption>Airflow Custom Operator Example</figcaption>
</figure>
</div>
</section>
</section>
<section id="custom-오퍼레이터-개발" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Custom 오퍼레이터 개발</h1>
<section id="custom-오퍼레이터-만들기" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="custom-오퍼레이터-만들기"><span class="header-section-number">6.1</span> Custom 오퍼레이터 만들기</h2>
<ul>
<li><strong>init</strong> 생성자 재정의</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>class SeoulApiToCsvOperator(BaseOperator):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  template_fields = (' endpoint', ' path','file_ name','base_dt')</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  def __init__(self , dataset_nm , path , file_name , base_dt=None , **kwargs):</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    #  dataset_nm , path , file_name , base_dt를 user로부터 받음</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    super().__init__(**kwargs)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    self.http_conn_id = 'openapi.seoul.go.kr' #hard coding</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    self.path = path</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    self.file_name = file_name</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    self.endpoint = '{{var.value.apikey_openapi_seoul_go_kr}}/json/' + datset_nm</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    self.base_dt =base_dt</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    # template 문법이 적용될 수 있도록 self.path 을 path로, </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    # self.file_name을 file_name로 </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    # self.endpoint 을 '{{var.value.apikey_openapi_seoul_go_kr}}/json/' + datset_nm로,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    # self.base_dt을 base_dt로 지정</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>dag full example</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>from airflow.models.baseoperator import BaseOperator</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>from airflow.hooks.base import BaseHook</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>import pandas as pd </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>class SeoulApiToCsvOperator(BaseOperator):</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    template_fields = ('endpoint', 'path','file_name','base_dt')</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="in">    def __init__(self, dataset_nm, path, file_name, base_dt=None, **kwargs):</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="in">        super().__init__(**kwargs)</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="in">        self.http_conn_id = 'openapi.seoul.go.kr'</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="in">        self.path = path</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="in">        self.file_name = file_name</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="in">        self.endpoint = '{{var.value.apikey_openapi_seoul_go_kr}}/json/' + dataset_nm</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="in">        self.base_dt = base_dt</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="in">    def execute(self, context):</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="in">    '''</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="in">    url:8080/endpoint</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="in">    endpoint=apikey/type/dataset_nm/start/end</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="in">    즉, url:8080/apikey/type/dataset_nm/start/end 로 줬어야 했다.</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="in">    '''</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="in">        import os</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="in">        connection = BaseHook.get_connection(self.http_conn_id)</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="in">        self.base_url = f'http://{connection.host}:{connection.port}/{self.endpoint}'</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="in">        total_row_df = pd.DataFrame()</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="in">        start_row = 1</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="in">        end_row = 1000</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="in">        while True:</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="in">            self.log.info(f'시작:{start_row}')</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="in">            self.log.info(f'끝:{end_row}')</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="in">            row_df = self._call_api(self.base_url, start_row, end_row)</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="in">            total_row_df = pd.concat([total_row_df, row_df])</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="in">            if len(row_df) &lt; 1000:</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="in">                break</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="in">            else:</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="in">                start_row = end_row + 1</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="in">                end_row += 1000</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="in">        if not os.path.exists(self.path):</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="in">            os.system(f'mkdir -p {self.path}')</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="in">        total_row_df.to_csv(self.path + '/' + self.file_name, encoding='utf-8', index=False)</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="in">    def _call_api(self, base_url, start_row, end_row):</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="in">        import requests #http의 get 요청을 하는 library</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="in">        import json </span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="in">        headers = {'Content-Type': 'application/json',</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="in">                   'charset': 'utf-8',</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="in">                   'Accept': '*/*'</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="in">                   }</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="in">        request_url = f'{base_url}/{start_row}/{end_row}/'</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a><span class="in">        if self.base_dt is not None:</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="in">            request_url = f'{base_url}/{start_row}/{end_row}/{self.base_dt}'</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="in">        response = requests.get(request_url, headers) # response는 dictionary형태의 string으로 들어옴</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="in">        contents = json.loads(response.text) # json.loads() string이 dictionary로 반환됨</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="in">        key_nm = list(contents.keys())[0]</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="in">        row_data = contents.get(key_nm).get('row')</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="in">        row_df = pd.DataFrame(row_data)</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="in">        return row_df</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="mardkown"><code>
from operators.seoul_api_to_csv_operator import SeoulApiToCsvOperator
from airflow import DAG
import pendulum

with DAG(
    dag_id='dags_seoul_api_corona',
    schedule='0 7 * * *',
    start_date=pendulum.datetime(2023,4,1, tz='Asia/Seoul'),
    catchup=False
) as dag:
    '''서울시 코로나19 확진자 발생동향'''
    tb_corona19_count_status = SeoulApiToCsvOperator(
        task_id='tb_corona19_count_status',
        dataset_nm='TbCorona19CountStatus',
        path='/opt/airflow/files/TbCorona19CountStatus/{{data_interval_end.in_timezone("Asia/Seoul") | ds_nodash }}',
        file_name='TbCorona19CountStatus.csv'
    )
    
    '''서울시 코로나19 백신 예방접종 현황'''
    tv_corona19_vaccine_stat_new = SeoulApiToCsvOperator(
        task_id='tv_corona19_vaccine_stat_new',
        dataset_nm='tvCorona19VaccinestatNew',
        path='/opt/airflow/files/tvCorona19VaccinestatNew/{{data_interval_end.in_timezone("Asia/Seoul") | ds_nodash }}',
        file_name='tvCorona19VaccinestatNew.csv'
    )

    tb_corona19_count_status &gt;&gt; tv_corona19_vaccine_stat_new</code></pre>
<ul>
<li>tb_corona19_count_status = SeoulApiToCsvOperator() 의 수행은 wokrer_container가 주체</li>
<li>SeoulApiToCsvOperator()의 path=‘/opt/airflow/files/TbCorona19CountStatus/{{data_interval_end.in_timezone(“Asia/Seoul”) | ds_nodash }}’.
<ul>
<li>여기서 worker container는 ‘/opt/airflow/files/TbCorona19CountStatus/{{data_interval_end.in_timezone(“Asia/Seoul”) | ds_nodash }}’ 연결이 안되어 있기 때문에</li>
<li>container가 내려갔다가 다시 올라오면 files의 내용은 다 사라짐</li>
<li>docker_compose.yaml에서 경로 지정을 해줘야 자동으로 인식하여 wsl/files에 csv가 자동으로 저장된다.</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>  volumes:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>${AIRFLOW_PROJ_DIR:-.}/airflow/dags:/opt/airflow/dags</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>${AIRFLOW_PROJ_DIR:-.}/logs:/opt/airflow/logs</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>${AIRFLOW_PROJ_DIR:-.}/config:/opt/airflow/config</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>${AIRFLOW_PROJ_DIR:-.}/airflow/plugins:/opt/airflow/plugin</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>${AIRFLOW_PROJ_DIR:-.}/airflow/files:/opt/airflow/files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>실행 날짜로 저장된 directory명안에 csv를 vi editor로 열고 <code>se nu</code> 명령어로 건수를 확인</li>
</ul></li>
</ul>
</section>
<section id="summary" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="summary"><span class="header-section-number">6.2</span> Summary</h2>
<ul>
<li>Custom 오퍼레이터를 만들면 왜 좋을까 ?
<ul>
<li>비효율성 제거
<ul>
<li>만약 custom 오퍼레이터를 만들지 않았다면</li>
<li>개발자마다 각자 서울 공공데이터 데이터셋 추출 저장하는 파이썬 파일을 만들어 PythonOperator 를 이용해 개발했을 것</li>
<li>비슷한 동작을 하는 파이썬 파일이 관리되지 않은 채 수십 개 만들어지면 그 자체로 비효율 발생</li>
<li>운영하는 사람 입장에서 비슷한 script가 여러 개 있으면 이해할 수가 없음</li>
</ul></li>
<li>재사용성 강화
<ul>
<li>특정기능을 하는 모듈을 만들어 놓고 , 상세 조건은 파라미터로 받게끔하여 모듈을 재사용할 수 있도록 유도</li>
<li>Custom 오퍼레이터 개발</li>
</ul></li>
</ul></li>
</ul>
</section>
</section>
</div>
</div>
<div id="English" class="tab-pane fade" role="tabpanel" aria-labelledby="English-tab">
<div id="English" class="tab-pane fade" role="tabpanel" aria-labelledby="English-tab">

</div>
</div>


</div>

</ul></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("kmink3225\.netlify\.app");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="./docs/comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->




</body></html>