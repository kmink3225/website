<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kwangmin Kim">
<meta name="dcterms.date" content="2023-05-01">
<meta name="description" content="template">

<title>Airflow Additional Function – Kwangmin Kim</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<script src="../../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../../.././images/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">Kwangmin Kim</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../docs/CV/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../docs/projects/index.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../../about.html"> 
<span class="menu-text">Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kmink3225"> <i class="bi bi-github" role="img" aria-label="Github">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/kwangmin-kim-a5241b200/"> <i class="bi bi-linkedin" role="img" aria-label="Linkedin">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Airflow Additional Function</h1>
<p class="subtitle lead">DAG Creation, Bash Operator, Task Performance Subject,</p>
  <div class="quarto-categories">
    <div class="quarto-category">Engineering</div>
  </div>
  </div>

<div>
  <div class="description">
    <p>template</p>
  </div>
</div>


<div class="quarto-title-meta column-page">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Kwangmin Kim </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 1, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<ul class="nav nav-pills" id="language-tab" role="tablist">
<li class="nav-item" role="presentation">
<button class="nav-link active" id="Korean-tab" data-bs-toggle="tab" data-bs-target="#Korean" type="button" role="tab" aria-controls="Korean" aria-selected="true">
Korean
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="English-tab" data-bs-toggle="tab" data-bs-target="#English" type="button" role="tab" aria-controls="knitr" aria-selected="false">
English
</button>
</li>
<div id="language-tabcontent" class="tab-content">
<div id="Korean" class="tab-pane fade show active" role="tabpanel" aria-labelledby="Korean-tab">
<p>몰라도 되지만 알면 좋은 고급 기능들</p>
<section id="dataset을-이용한-dag-트리거" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Dataset을 이용한 Dag 트리거</h1>
<section id="dataset의-필요성" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="dataset의-필요성"><span class="header-section-number">1.1</span> Dataset의 필요성</h2>
<ul>
<li>case 1</li>
</ul>
<div class="columns">
<div class="column" style="width:50%;">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 184.00 186.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 182)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-182 180,-182 180,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster0</title>
<polygon fill="none" stroke="black" points="8,-8 8,-85 168,-85 168,-8 8,-8"></polygon>
<text text-anchor="middle" x="88" y="-68.4" font-family="Times,serif" font-size="14.00">DAG A</text>
</g>
<g id="clust2" class="cluster">
<title>cluster1</title>
<polygon fill="none" stroke="black" points="8,-93 8,-170 78,-170 78,-93 8,-93"></polygon>
<text text-anchor="middle" x="43" y="-153.4" font-family="Times,serif" font-size="14.00">DAG B</text>
</g>
<!-- task_1 -->
<g id="node1" class="node">
<title>task_1</title>
<polygon fill="none" stroke="black" points="70,-52 16,-52 16,-16 70,-16 70,-52"></polygon>
<text text-anchor="middle" x="43" y="-29.8" font-family="Times,serif" font-size="14.00">task_1</text>
</g>
<!-- task_3 -->
<g id="node2" class="node">
<title>task_3</title>
<polygon fill="none" stroke="black" points="160,-52 106,-52 106,-16 160,-16 160,-52"></polygon>
<text text-anchor="middle" x="133" y="-29.8" font-family="Times,serif" font-size="14.00">task_3</text>
</g>
<!-- task_1&#45;&gt;task_3 -->
<g id="edge1" class="edge">
<title>task_1-&gt;task_3</title>
<path fill="none" stroke="black" d="M70.4,-34C78.39,-34 87.31,-34 95.82,-34"></path>
<polygon fill="black" stroke="black" points="95.92,-37.5 105.92,-34 95.92,-30.5 95.92,-37.5"></polygon>
</g>
<!-- task_k -->
<g id="node3" class="node">
<title>task_k</title>
<polygon fill="none" stroke="black" points="70,-137 16,-137 16,-101 70,-101 70,-137"></polygon>
<text text-anchor="middle" x="43" y="-114.8" font-family="Times,serif" font-size="14.00">task_k</text>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li>위의 경우를 Task_1 뿐만 아니라 DAG_B의 task_k 에도 선행 의존관계가 걸리도록 External Task 센서를 하나 달도록 개선</li>
</ul>
</div><div class="column" style="width:50%;">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 269.66 325.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 321)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-321 265.66,-321 265.66,4 -4,4"></polygon>
<g id="clust3" class="cluster">
<title>cluster2</title>
<polygon fill="none" stroke="black" points="183.66,-8 183.66,-85 253.66,-85 253.66,-8 183.66,-8"></polygon>
<text text-anchor="middle" x="218.66" y="-68.4" font-family="Times,serif" font-size="14.00">DAG B</text>
</g>
<g id="clust1" class="cluster">
<title>cluster0</title>
<polygon fill="none" stroke="black" points="183.66,-93 183.66,-170 253.66,-170 253.66,-93 183.66,-93"></polygon>
<text text-anchor="middle" x="218.66" y="-153.4" font-family="Times,serif" font-size="14.00">DAG A</text>
</g>
<g id="clust2" class="cluster">
<title>cluster1</title>
<polygon fill="none" stroke="black" points="8,-178 8,-309 253.66,-309 253.66,-178 8,-178"></polygon>
<text text-anchor="middle" x="130.83" y="-292.4" font-family="Times,serif" font-size="14.00">DAG C</text>
</g>
<!-- task_1 -->
<g id="node1" class="node">
<title>task_1</title>
<polygon fill="none" stroke="black" points="245.66,-137 191.66,-137 191.66,-101 245.66,-101 245.66,-137"></polygon>
<text text-anchor="middle" x="218.66" y="-114.8" font-family="Times,serif" font-size="14.00">task_1</text>
</g>
<!-- Sensor_task_1 -->
<g id="node2" class="node">
<title>Sensor_task_1</title>
<polygon fill="none" stroke="black" points="113.49,-276 16.17,-276 16.17,-240 113.49,-240 113.49,-276"></polygon>
<text text-anchor="middle" x="64.83" y="-253.8" font-family="Times,serif" font-size="14.00">Sensor_task_1</text>
</g>
<!-- Sensor_task_1&#45;&gt;task_1 -->
<g id="edge3" class="edge">
<title>Sensor_task_1-&gt;task_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M100.88,-239.9C105.32,-237.12 109.69,-234.13 113.66,-231 146.08,-205.41 177.52,-169.54 197.19,-145.34"></path>
<polygon fill="black" stroke="black" points="200.11,-147.3 203.64,-137.31 194.65,-142.92 200.11,-147.3"></polygon>
<text text-anchor="middle" x="152.66" y="-218.2" font-family="Times,serif" font-size="14.00">sensing</text>
</g>
<!-- task_x -->
<g id="node4" class="node">
<title>task_x</title>
<polygon fill="none" stroke="black" points="245.66,-249 191.66,-249 191.66,-213 245.66,-213 245.66,-249"></polygon>
<text text-anchor="middle" x="218.66" y="-226.8" font-family="Times,serif" font-size="14.00">task_x</text>
</g>
<!-- Sensor_task_1&#45;&gt;task_x -->
<g id="edge1" class="edge">
<title>Sensor_task_1-&gt;task_x</title>
<path fill="none" stroke="black" d="M113.87,-249.46C135.77,-245.56 161.26,-241.03 181.5,-237.43"></path>
<polygon fill="black" stroke="black" points="182.33,-240.84 191.56,-235.64 181.1,-233.95 182.33,-240.84"></polygon>
</g>
<!-- Sensor_task_2 -->
<g id="node3" class="node">
<title>Sensor_task_2</title>
<polygon fill="none" stroke="black" points="113.49,-222 16.17,-222 16.17,-186 113.49,-186 113.49,-222"></polygon>
<text text-anchor="middle" x="64.83" y="-199.8" font-family="Times,serif" font-size="14.00">Sensor_task_2</text>
</g>
<!-- Sensor_task_2&#45;&gt;task_x -->
<g id="edge2" class="edge">
<title>Sensor_task_2-&gt;task_x</title>
<path fill="none" stroke="black" d="M113.87,-212.54C135.77,-216.44 161.26,-220.97 181.5,-224.57"></path>
<polygon fill="black" stroke="black" points="181.1,-228.05 191.56,-226.36 182.33,-221.16 181.1,-228.05"></polygon>
</g>
<!-- task_k -->
<g id="node5" class="node">
<title>task_k</title>
<polygon fill="none" stroke="black" points="245.66,-52 191.66,-52 191.66,-16 245.66,-16 245.66,-52"></polygon>
<text text-anchor="middle" x="218.66" y="-29.8" font-family="Times,serif" font-size="14.00">task_k</text>
</g>
<!-- Sensor_task_2&#45;&gt;task_k -->
<g id="edge4" class="edge">
<title>Sensor_task_2-&gt;task_k</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M82.08,-185.81C109.13,-155.52 163.5,-94.64 194.54,-59.89"></path>
<polygon fill="black" stroke="black" points="197.48,-61.85 201.53,-52.06 192.26,-57.19 197.48,-61.85"></polygon>
<text text-anchor="middle" x="152.66" y="-133.2" font-family="Times,serif" font-size="14.00">sensing</text>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
</div>
<ul>
<li>case 2</li>
</ul>
<div class="columns">
<div class="column" style="width:50%;">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 184.00 155.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 151)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-151 180,-151 180,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster0</title>
<polygon fill="none" stroke="black" points="8,-8 8,-139 168,-139 168,-8 8,-8"></polygon>
<text text-anchor="middle" x="88" y="-122.4" font-family="Times,serif" font-size="14.00">DAG A</text>
</g>
<!-- task_1 -->
<g id="node1" class="node">
<title>task_1</title>
<polygon fill="none" stroke="black" points="70,-106 16,-106 16,-70 70,-70 70,-106"></polygon>
<text text-anchor="middle" x="43" y="-83.8" font-family="Times,serif" font-size="14.00">task_1</text>
</g>
<!-- task_3 -->
<g id="node2" class="node">
<title>task_3</title>
<polygon fill="none" stroke="black" points="160,-106 106,-106 106,-70 160,-70 160,-106"></polygon>
<text text-anchor="middle" x="133" y="-83.8" font-family="Times,serif" font-size="14.00">task_3</text>
</g>
<!-- task_1&#45;&gt;task_3 -->
<g id="edge1" class="edge">
<title>task_1-&gt;task_3</title>
<path fill="none" stroke="black" d="M70.4,-88C78.39,-88 87.31,-88 95.82,-88"></path>
<polygon fill="black" stroke="black" points="95.92,-91.5 105.92,-88 95.92,-84.5 95.92,-91.5"></polygon>
</g>
<!-- task_4 -->
<g id="node3" class="node">
<title>task_4</title>
<polygon fill="none" stroke="black" points="70,-52 16,-52 16,-16 70,-16 70,-52"></polygon>
<text text-anchor="middle" x="43" y="-29.8" font-family="Times,serif" font-size="14.00">task_4</text>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li>위의 경우, Task_1이 완료되면 또 다른 dag 을 trigger 되고 싶은데 DAG A 를 수정해야할 경우</li>
</ul>
</div><div class="column" style="width:50%;">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 184.00 155.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 151)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-151 180,-151 180,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster</title>
<polygon fill="none" stroke="black" points="8,-8 8,-139 168,-139 168,-8 8,-8"></polygon>
<text text-anchor="middle" x="88" y="-122.4" font-family="Times,serif" font-size="14.00">DAG A</text>
</g>
<!-- task_1 -->
<g id="node1" class="node">
<title>task_1</title>
<polygon fill="none" stroke="black" points="70,-79 16,-79 16,-43 70,-43 70,-79"></polygon>
<text text-anchor="middle" x="43" y="-56.8" font-family="Times,serif" font-size="14.00">task_1</text>
</g>
<!-- task_3 -->
<g id="node2" class="node">
<title>task_3</title>
<polygon fill="none" stroke="black" points="160,-52 106,-52 106,-16 160,-16 160,-52"></polygon>
<text text-anchor="middle" x="133" y="-29.8" font-family="Times,serif" font-size="14.00">task_3</text>
</g>
<!-- task_1&#45;&gt;task_3 -->
<g id="edge1" class="edge">
<title>task_1-&gt;task_3</title>
<path fill="none" stroke="black" d="M70.4,-52.9C78.48,-50.42 87.51,-47.65 96.1,-45.01"></path>
<polygon fill="black" stroke="black" points="97.39,-48.28 105.92,-42 95.33,-41.59 97.39,-48.28"></polygon>
</g>
<!-- task_4 -->
<g id="node3" class="node">
<title>task_4</title>
<polygon fill="none" stroke="black" points="160,-106 106,-106 106,-70 160,-70 160,-106"></polygon>
<text text-anchor="middle" x="133" y="-83.8" font-family="Times,serif" font-size="14.00">task_4</text>
</g>
<!-- task_1&#45;&gt;task_4 -->
<g id="edge2" class="edge">
<title>task_1-&gt;task_4</title>
<path fill="none" stroke="black" d="M70.4,-69.1C78.48,-71.58 87.51,-74.35 96.1,-76.99"></path>
<polygon fill="black" stroke="black" points="95.33,-80.41 105.92,-80 97.39,-73.72 95.33,-80.41"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
</div>
<ul>
<li>TriggerDagRun 오퍼레이터와 ExternalTask 센서를 많이 사용하다보면 연결관리 에 많은 노력이 필요 (강한 연결)</li>
</ul>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 301.55 209.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 205)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-205 297.55,-205 297.55,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster</title>
<polygon fill="none" stroke="black" points="8,-8 8,-193 285.55,-193 285.55,-8 8,-8"></polygon>
<text text-anchor="middle" x="146.78" y="-176.4" font-family="Times,serif" font-size="14.00">DAG Flow</text>
</g>
<!-- DAG_A -->
<g id="node1" class="node">
<title>DAG_A</title>
<polygon fill="none" stroke="black" points="79.66,-133 15.78,-133 15.78,-97 79.66,-97 79.66,-133"></polygon>
<text text-anchor="middle" x="47.72" y="-110.8" font-family="Times,serif" font-size="14.00">DAG_A</text>
</g>
<!-- DAG_B -->
<g id="node2" class="node">
<title>DAG_B</title>
<polygon fill="none" stroke="black" points="177.95,-160 115.61,-160 115.61,-124 177.95,-124 177.95,-160"></polygon>
<text text-anchor="middle" x="146.78" y="-137.8" font-family="Times,serif" font-size="14.00">DAG_B</text>
</g>
<!-- DAG_A&#45;&gt;DAG_B -->
<g id="edge1" class="edge">
<title>DAG_A-&gt;DAG_B</title>
<path fill="none" stroke="black" d="M79.7,-123.62C87.91,-125.9 96.9,-128.4 105.53,-130.8"></path>
<polygon fill="black" stroke="black" points="104.85,-134.25 115.43,-133.56 106.73,-127.5 104.85,-134.25"></polygon>
</g>
<!-- DAG_C -->
<g id="node3" class="node">
<title>DAG_C</title>
<polygon fill="none" stroke="black" points="177.95,-106 115.61,-106 115.61,-70 177.95,-70 177.95,-106"></polygon>
<text text-anchor="middle" x="146.78" y="-83.8" font-family="Times,serif" font-size="14.00">DAG_C</text>
</g>
<!-- DAG_A&#45;&gt;DAG_C -->
<g id="edge2" class="edge">
<title>DAG_A-&gt;DAG_C</title>
<path fill="none" stroke="black" d="M79.7,-106.38C87.91,-104.1 96.9,-101.6 105.53,-99.2"></path>
<polygon fill="black" stroke="black" points="106.73,-102.5 115.43,-96.44 104.85,-95.75 106.73,-102.5"></polygon>
</g>
<!-- DAG_D -->
<g id="node4" class="node">
<title>DAG_D</title>
<polygon fill="none" stroke="black" points="79.66,-79 15.78,-79 15.78,-43 79.66,-43 79.66,-79"></polygon>
<text text-anchor="middle" x="47.72" y="-56.8" font-family="Times,serif" font-size="14.00">DAG_D</text>
</g>
<!-- DAG_D&#45;&gt;DAG_C -->
<g id="edge3" class="edge">
<title>DAG_D-&gt;DAG_C</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M79.7,-69.62C87.91,-71.9 96.9,-74.4 105.53,-76.8"></path>
<polygon fill="black" stroke="black" points="104.85,-80.25 115.43,-79.56 106.73,-73.5 104.85,-80.25"></polygon>
</g>
<!-- DAG_E -->
<g id="node5" class="node">
<title>DAG_E</title>
<polygon fill="none" stroke="black" points="177.66,-52 115.89,-52 115.89,-16 177.66,-16 177.66,-52"></polygon>
<text text-anchor="middle" x="146.78" y="-29.8" font-family="Times,serif" font-size="14.00">DAG_E</text>
</g>
<!-- DAG_D&#45;&gt;DAG_E -->
<g id="edge4" class="edge">
<title>DAG_D-&gt;DAG_E</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M79.7,-52.38C88.08,-50.05 97.27,-47.49 106.06,-45.05"></path>
<polygon fill="black" stroke="black" points="107.06,-48.4 115.76,-42.35 105.18,-41.66 107.06,-48.4"></polygon>
</g>
<!-- DAG_G -->
<g id="node6" class="node">
<title>DAG_G</title>
<polygon fill="none" stroke="black" points="277.77,-52 213.89,-52 213.89,-16 277.77,-16 277.77,-52"></polygon>
<text text-anchor="middle" x="245.83" y="-29.8" font-family="Times,serif" font-size="14.00">DAG_G</text>
</g>
<!-- DAG_E&#45;&gt;DAG_G -->
<g id="edge5" class="edge">
<title>DAG_E-&gt;DAG_G</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M177.69,-34C185.93,-34 195.03,-34 203.79,-34"></path>
<polygon fill="black" stroke="black" points="203.84,-37.5 213.84,-34 203.84,-30.5 203.84,-37.5"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li>큐시스템과 같이 Job 수행이 완료된 Task 는 Push 하고 센싱이 필요한 task 은 큐 시스템을 구독하는 방식을 쓴다면 ? (약한 연결)</li>
</ul>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 292.11 209.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 205)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-205 288.11,-205 288.11,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster</title>
<polygon fill="none" stroke="black" points="8,-8 8,-193 276.11,-193 276.11,-8 8,-8"></polygon>
<text text-anchor="middle" x="142.06" y="-176.4" font-family="Times,serif" font-size="14.00">DAG Flow</text>
</g>
<!-- DAG_A -->
<g id="node1" class="node">
<title>DAG_A</title>
<polygon fill="none" stroke="black" points="79.66,-160 15.78,-160 15.78,-124 79.66,-124 79.66,-160"></polygon>
<text text-anchor="middle" x="47.72" y="-137.8" font-family="Times,serif" font-size="14.00">DAG_A</text>
</g>
<!-- Queue -->
<g id="node7" class="node">
<title>Queue</title>
<path fill="none" stroke="black" d="M169.44,-102.73C169.44,-104.53 157.34,-106 142.44,-106 127.54,-106 115.44,-104.53 115.44,-102.73 115.44,-102.73 115.44,-73.27 115.44,-73.27 115.44,-71.47 127.54,-70 142.44,-70 157.34,-70 169.44,-71.47 169.44,-73.27 169.44,-73.27 169.44,-102.73 169.44,-102.73"></path>
<path fill="none" stroke="black" d="M169.44,-102.73C169.44,-100.92 157.34,-99.45 142.44,-99.45 127.54,-99.45 115.44,-100.92 115.44,-102.73"></path>
<text text-anchor="middle" x="142.44" y="-83.8" font-family="Times,serif" font-size="14.00">Queue</text>
</g>
<!-- DAG_A&#45;&gt;Queue -->
<g id="edge1" class="edge">
<title>DAG_A-&gt;Queue</title>
<path fill="none" stroke="black" d="M79.6,-124.02C88.29,-118.96 97.8,-113.42 106.7,-108.23"></path>
<polygon fill="black" stroke="black" points="108.47,-111.25 115.35,-103.2 104.94,-105.21 108.47,-111.25"></polygon>
</g>
<!-- DAG_B -->
<g id="node2" class="node">
<title>DAG_B</title>
<polygon fill="none" stroke="black" points="267.95,-52 205.61,-52 205.61,-16 267.95,-16 267.95,-52"></polygon>
<text text-anchor="middle" x="236.78" y="-29.8" font-family="Times,serif" font-size="14.00">DAG_B</text>
</g>
<!-- DAG_C -->
<g id="node3" class="node">
<title>DAG_C</title>
<polygon fill="none" stroke="black" points="267.95,-106 205.61,-106 205.61,-70 267.95,-70 267.95,-106"></polygon>
<text text-anchor="middle" x="236.78" y="-83.8" font-family="Times,serif" font-size="14.00">DAG_C</text>
</g>
<!-- DAG_D -->
<g id="node4" class="node">
<title>DAG_D</title>
<polygon fill="none" stroke="black" points="79.66,-106 15.78,-106 15.78,-70 79.66,-70 79.66,-106"></polygon>
<text text-anchor="middle" x="47.72" y="-83.8" font-family="Times,serif" font-size="14.00">DAG_D</text>
</g>
<!-- DAG_D&#45;&gt;Queue -->
<g id="edge2" class="edge">
<title>DAG_D-&gt;Queue</title>
<path fill="none" stroke="black" d="M79.6,-88C87.83,-88 96.81,-88 105.31,-88"></path>
<polygon fill="black" stroke="black" points="105.35,-91.5 115.35,-88 105.35,-84.5 105.35,-91.5"></polygon>
</g>
<!-- DAG_E -->
<g id="node5" class="node">
<title>DAG_E</title>
<polygon fill="none" stroke="black" points="267.66,-160 205.89,-160 205.89,-124 267.66,-124 267.66,-160"></polygon>
<text text-anchor="middle" x="236.78" y="-137.8" font-family="Times,serif" font-size="14.00">DAG_E</text>
</g>
<!-- DAG_G -->
<g id="node6" class="node">
<title>DAG_G</title>
<polygon fill="none" stroke="black" points="79.66,-52 15.78,-52 15.78,-16 79.66,-16 79.66,-52"></polygon>
<text text-anchor="middle" x="47.72" y="-29.8" font-family="Times,serif" font-size="14.00">DAG_G</text>
</g>
<!-- Queue&#45;&gt;DAG_B -->
<g id="edge3" class="edge">
<title>Queue-&gt;DAG_B</title>
<path fill="none" stroke="black" d="M169.65,-72.67C178.14,-67.71 187.74,-62.09 196.94,-56.71"></path>
<polygon fill="black" stroke="black" points="198.72,-59.73 205.59,-51.66 195.19,-53.68 198.72,-59.73"></polygon>
</g>
<!-- Queue&#45;&gt;DAG_C -->
<g id="edge4" class="edge">
<title>Queue-&gt;DAG_C</title>
<path fill="none" stroke="black" d="M169.65,-88C177.7,-88 186.75,-88 195.51,-88"></path>
<polygon fill="black" stroke="black" points="195.59,-91.5 205.59,-88 195.59,-84.5 195.59,-91.5"></polygon>
</g>
<!-- Queue&#45;&gt;DAG_E -->
<g id="edge5" class="edge">
<title>Queue-&gt;DAG_E</title>
<path fill="none" stroke="black" d="M169.65,-103.33C178.14,-108.29 187.74,-113.91 196.94,-119.29"></path>
<polygon fill="black" stroke="black" points="195.19,-122.32 205.59,-124.34 198.72,-116.27 195.19,-122.32"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li>Produce / Consume 구조를 이용하여 Task 완료를 알리기 위해 특정 키 값으로 Produce 하고 해당 키를 Consume 하는 DAG 을 트리거 스케줄 할 수 있는 기능
<ul>
<li>실제 큐가 있는 것은 아니고 DB 에 Produce / Consume 내역을 기록</li>
</ul></li>
</ul>
</section>
<section id="정리" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="정리"><span class="header-section-number">1.2</span> 정리</h2>
<ul>
<li>Dataset 은 Pub/sub 구조로 DAG 간 의존관계를 주는 방법</li>
<li>Unique 한 String 형태의 Key 값을 부여하여 Dataset Publish</li>
<li>Dataset 을 Consume 하는 DAG 은 스케줄을 별도로 주지 않고 리스트 형태로 구독할 Dataset 요소들을 명시</li>
<li>Dataset에 의해 시작된 DAG 의 Run_id 는 dataset_triggered__{trigger 된 시간 } 으로 표현됨</li>
<li>Airflow 화면 메뉴 중 Datasets 메뉴를 통해 별도로 Dataset 현황 모니터링 가능</li>
<li>N개의 Dataset 을 구독할 때 스케줄링 시점은 ?
<ul>
<li>마지막 수행 이후 N 개의 Dataset 이 모두 재 업데이트되는 시점 <img src="../../../../../images/airflow/dataset_trigger.PNG" class="img-fluid" alt="Trigger using dataset - N개의 dataset 구독"></li>
</ul></li>
</ul>
</section>
</section>
<section id="dag의-default_args-파라미터" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> DAG의 default_args 파라미터</h1>
<section id="dag-의-default_args-파라미터" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="dag-의-default_args-파라미터"><span class="header-section-number">2.1</span> DAG 의 default_args 파라미터</h2>
<ul>
<li>목적: DAG 하위 모든 오퍼레이터에 공통 적용될 파라미터를 입력</li>
<li>어떤 파라미터들이 적용 가능할까?
<ul>
<li>오퍼레이터에 공통 적용할 수 있는 파라미터들</li>
<li>BaseOperator 클래스 생성자가 가지고 있는 파라미터</li>
</ul></li>
<li><a href="https://airflow.apache.org/docs/apache-airflow/stable/_modules/airflow/models/baseoperator.html#BaseOperator">airflow doc</a></li>
<li>Code</li>
</ul>
<div class="columns">
<div class="column" style="width:50%;">
<div class="sourceCode" id="cb1"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>from airflow import DAG</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>from airflow.operators.bash import BashOperator</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>from datetime import timedelta</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>import pendulum</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>from airflow.models import Variable</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>email_str = Variable.get("email_target")</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>email_lst = <span class="co">[</span><span class="ot">email.strip() for email in email_str.split(',')</span><span class="co">]</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>with DAG(</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    dag_id='dags_sla_email_example',</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    start_date=pendulum.datetime(2023, 5, 1, tz='Asia/Seoul'),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    schedule='*/10 * * * *',</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    catchup=False,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>) as dag:</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="in">    task_1 = BashOperator(</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_1',</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 10m',</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="in">        sla: timedelta(seconds=70), #SLA 설정</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="in">        email: 'sdf@sdfsfd.com'</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="in">    task_2 = BashOperator(</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_2',</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 2m',</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="in">        sla: timedelta(seconds=70), #SLA 설정</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="in">        email: 'sdf@sdfsfd.com'</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>   task_1 &gt;&gt; task_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column" style="width:50%;">
<div class="sourceCode" id="cb2"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>from airflow import DAG</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>from airflow.operators.bash import BashOperator</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>from datetime import timedelta</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>import pendulum</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>from airflow.models import Variable</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>email_str = Variable.get("email_target")</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>email_lst = <span class="co">[</span><span class="ot">email.strip() for email in email_str.split(',')</span><span class="co">]</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>with DAG(</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    dag_id='dags_sla_email_example',</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    start_date=pendulum.datetime(2023, 5, 1, tz='Asia/Seoul'),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    schedule='*/10 * * * *',</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    catchup=False,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    default_args={</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        'sla': timedelta(seconds=70),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        'email': 'sdf@sdfsfd.com'</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>) as dag:</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="in">    task_1 = BashOperator(</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_1',</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 10m'</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="in">    task_2 = BashOperator(</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_2',</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 2m'</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>   task_1 &gt;&gt; task_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="baseoperator-파라미터-vs-dag-파라미터" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="baseoperator-파라미터-vs-dag-파라미터"><span class="header-section-number">2.2</span> BaseOperator 파라미터 vs Dag 파라미터</h2>
<div class="columns">
<div class="column" style="width:40%;">
<section id="dag-parameter" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="dag-parameter"><span class="header-section-number">2.2.1</span> DAG Parameter</h3>
<ul>
<li>DAG 파라미터는 DAG 단위로 적용될 파라미터</li>
<li>개별 오퍼레이터에 적용되지 않음</li>
<li>DAG 파라미터는 default_args 에 전달하면 안됨</li>
</ul>
</section>
</div><div class="column" style="width:60%;">
<section id="baseoperator-parameter" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="baseoperator-parameter"><span class="header-section-number">2.2.2</span> BaseOperator Parameter</h3>
<ul>
<li>Base 오퍼레이터 파라미터는 개별 Task 단위로 적용될 파라미터.</li>
<li>Task 마다 선언해줄 수 있지만 DAG 하위 모든 오퍼레이터에 적용 필요시 default_args 를 통해 전달 가능</li>
</ul>
</section>
</div>
</div>
<ul>
<li>default_args 에 전달된 파라미터보다 개별 오퍼레이터에 선언된 파라미터가 우선순위를 가짐</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>from airflow import DAG</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>from airflow.operators.bash import BashOperator</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>from datetime import timedelta</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>import pendulum</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>from airflow.models import Variable</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>email_str = Variable.get("email_target")</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>email_lst = <span class="co">[</span><span class="ot">email.strip() for email in email_str.split(',')</span><span class="co">]</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>with DAG(</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    dag_id='dags_sla_email_example',</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    start_date=pendulum.datetime(2023, 5, 1, tz='Asia/Seoul'),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    schedule='*/10 * * * *',</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    catchup=False,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    default_args={</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        'sla': timedelta(seconds=70),</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        'email': 'sdf@sdfsfd.com'</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>) as dag:</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="in">    task_1 = BashOperator(</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_1',</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 10m'</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="in">    task_2 = BashOperator(</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_2',</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 2m',</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="in">        sla=timedelta(minutes=1)</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>   task_1 &gt;&gt; task_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="task-실패시-email-발송하기" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Task 실패시 Email 발송하기</h1>
<section id="email-발송-위한-파라미터-확인" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="email-발송-위한-파라미터-확인"><span class="header-section-number">3.1</span> Email 발송 위한 파라미터 확인</h2>
<ul>
<li><a href="https://airflow.apache.org/docs/apache-airflow/stable/_modules/airflow/models/baseoperator.html#BaseOperator">airflow doc</a></li>
<li>email 파라미터와 email_on_failure 파라미터를 이용</li>
<li>email 파라미터만 입력하면 email_on_failure 파라미터는 True 로 자동설정됨</li>
</ul>
</section>
<section id="email-발송-대상-등록" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="email-발송-대상-등록"><span class="header-section-number">3.2</span> Email 발송 대상 등록</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>from airflow import DAG</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>from airflow.operators.bash import BashOperator</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>from airflow.decorators import task</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>from airflow.exceptions import AirflowException</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>import pendulum</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>from datetime import timedelta</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>from airflow.models import Variable</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>email_str = Variable.get("email_target")</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>email_lst = <span class="co">[</span><span class="ot">email.strip() for email in email_str.split(',')</span><span class="co">]</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>with DAG(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    dag_id='dags_email_on_failure',</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    start_date=pendulum.datetime(2023,5,1, tz='Asia/Seoul'),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    catchup=False,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    schedule='0 1 * * *',</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    dagrun_timeout=timedelta(minutes=2),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    default_args={</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        'email_on_failure': True,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        'email': email_lst</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>) as dag:</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    @task(task_id='python_fail')</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    def python_task_func():</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        raise AirflowException('에러 발생')</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    python_task_func()</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="in">    bash_fail = BashOperator(</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='bash_fail',</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='exit 1',</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="in">    bash_success = BashOperator(</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='bash_success',</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='exit 0',</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Email 받을 대상이 1 명이면 string 형식으로 , 2 명 이상이면 list 로 전달</li>
<li>그런데 협업 환경에서 DAG 담당자는 수시로 바뀔 수 있고 인원도 수시로 바뀔 수 있는데 그때마다 DAG 을 뒤져서 email 리스트를 수정해야 할까 ?</li>
<li>이럴때 Variable 을 이용하자</li>
</ul>
</section>
</section>
<section id="sla로-task-수행-감시-email-발송하기" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> SLA로 task 수행 감시 &amp; Email 발송하기</h1>
<section id="sla파라미터-이해" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="sla파라미터-이해"><span class="header-section-number">4.1</span> SLA파라미터 이해</h2>
<ul>
<li><p>개념: 오퍼레이터 수행시 정해놓은 시간을 초과하였는지를 판단할 수 있도록 설정해놓은 시간 값 파이썬의 timedelta 로 정의</p></li>
<li><p>동작: 설정해놓은 SLA 를 초과하여 오퍼레이터 running 시 SLA Miss 발생 , Airflow UI 화면에서 Miss 건만 조회 가능 + email 발송 가능</p>
<ul>
<li>SLA Miss 발생시 task 가 실패되는 것은 아니며 단순 Miss 대상에 기록만 DB에 남기게 됨</li>
<li>SLA 는 DAG 파라미터가 아니며 BaseOperator 의 파라미터</li>
</ul></li>
<li><p><a href="https://airflow.apache.org/docs/apache-airflow/stable/_modules/airflow/models/baseoperator.html#BaseOperator">airflow docs- def <strong>init</strong></a></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a> def __init__(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>      self,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>      task_id: str,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>      owner: str = DEFAULT_OWNER,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      email: str | Iterable<span class="co">[</span><span class="ot">str</span><span class="co">]</span> | None = None,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      email_on_retry: bool = conf.getboolean("email", "default_email_on_retry", fallback=True),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      email_on_failure: bool = conf.getboolean("email", "default_email_on_failure", fallback=True),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>      retries: int | None = DEFAULT_RETRIES,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>      retry_delay: timedelta | float = DEFAULT_RETRY_DELAY,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      retry_exponential_backoff: bool = False,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>      max_retry_delay: timedelta | float | None = None,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>      start_date: datetime | None = None,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>      end_date: datetime | None = None,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      depends_on_past: bool = False,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>      ignore_first_depends_on_past: bool = DEFAULT_IGNORE_FIRST_DEPENDS_ON_PAST,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>      wait_for_past_depends_before_skipping: bool = DEFAULT_WAIT_FOR_PAST_DEPENDS_BEFORE_SKIPPING,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>      wait_for_downstream: bool = False,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      dag: DAG | None = None,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>      params: collections.abc.MutableMapping | None = None,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>      default_args: dict | None = None,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>      priority_weight: int = DEFAULT_PRIORITY_WEIGHT,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>      weight_rule: str = DEFAULT_WEIGHT_RULE,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>      queue: str = DEFAULT_QUEUE,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>      pool: str | None = None,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>      pool_slots: int = DEFAULT_POOL_SLOTS,</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>      sla: timedelta | None = None, # sla 변수</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>      execution_timeout: timedelta | None = DEFAULT_TASK_EXECUTION_TIMEOUT,</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      on_execute_callback: None | TaskStateChangeCallback | list<span class="co">[</span><span class="ot">TaskStateChangeCallback</span><span class="co">]</span> = None,</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>      on_failure_callback: None | TaskStateChangeCallback | list<span class="co">[</span><span class="ot">TaskStateChangeCallback</span><span class="co">]</span> = None,</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      on_success_callback: None | TaskStateChangeCallback | list<span class="co">[</span><span class="ot">TaskStateChangeCallback</span><span class="co">]</span> = None,</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>      on_retry_callback: None | TaskStateChangeCallback | list<span class="co">[</span><span class="ot">TaskStateChangeCallback</span><span class="co">]</span> = None,</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>      pre_execute: TaskPreExecuteHook | None = None,</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>      post_execute: TaskPostExecuteHook | None = None,</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>      trigger_rule: str = DEFAULT_TRIGGER_RULE,</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>      resources: dict<span class="co">[</span><span class="ot">str, Any</span><span class="co">]</span> | None = None,</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>      run_as_user: str | None = None,</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      task_concurrency: int | None = None,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      max_active_tis_per_dag: int | None = None,</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>      max_active_tis_per_dagrun: int | None = None,</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>      executor_config: dict | None = None,</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>      do_xcom_push: bool = True,</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>      inlets: Any | None = None,</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      outlets: Any | None = None,</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>      task_group: TaskGroup | None = None,</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>      doc: str | None = None,</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>      doc_md: str | None = None,</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>      doc_json: str | None = None,</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>      doc_yaml: str | None = None,</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>      doc_rst: str | None = None,</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>      **kwargs,</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>  ):</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>sla: timedelta | None = None, # sla 변수
<ul>
<li>timedelta보다 오랜 시간동안 task가 더 오래 수행되면 SLA Miss 기록만 남기고 실패처리는 안하게 됨</li>
<li>default_arg에 넣을 수 있기 때문에 모든 task, 즉 모든 operator에 공통 적용할 수 있다.</li>
</ul></li>
</ul></li>
<li><p><a href="https://airflow.apache.org/docs/apache-airflow/stable/_modules/airflow/models/dag.html">sla_miss_callback: DAG에 있는 SLA 관련 파라미터로 SLA Miss시 수행할 함수 지정 가능-Source code for airflow.models.dag</a></p>
<ul>
<li>sla_miss_callback 파라미터
<ul>
<li>sla miss시 수행할 함수명을 입력 받음</li>
<li>dag에 있는 파라미터이기 때문에 default_arg에 넣을 수 없음</li>
</ul></li>
<li>DAG의 파라미터임 (BaseOperator 의 파라미터가 아니라는 것에 유의)</li>
</ul></li>
</ul>
</section>
<section id="sla-제약사항" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="sla-제약사항"><span class="header-section-number">4.2</span> SLA 제약사항</h2>
<ul>
<li>1번째 제약사항: 각 Task 의 SLA timeout 카운트 시작은 DAG 의 시작시간 기준임</li>
</ul>
<div class="columns">
<div class="column" style="width:40%;">
<section id="사람이-생각하는-sla-timeout-카운트-방식" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="사람이-생각하는-sla-timeout-카운트-방식"><span class="header-section-number">4.2.1</span> 사람이 생각하는 SLA timeout 카운트 방식</h3>
<p><img src="../../../../../images/airflow/SLA_timeout_count1.PNG" class="img-fluid"></p>
<ul>
<li>처음 사용하는 사용자들은 다음과 같이 생각할 수 있다.
<ul>
<li>task1은 task1의 sla구간보다 수행시간이 짧게 완료됐기 때문에 성공 처리</li>
<li>task2는 sla 구간보다 더 길기 때문에 miss 처리됨</li>
<li>task3는 sla 구간보다 짧기 때문에 성공 처리</li>
</ul></li>
<li>airflow는 위와 같이 동작하지 않음 옆의 그림과 같이 동작함</li>
</ul>
</section>
</div><div class="column" style="width:60%;">
<section id="실제-airflow-의-sla-timeout-카운트-방식" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="실제-airflow-의-sla-timeout-카운트-방식"><span class="header-section-number">4.2.2</span> 실제 Airflow 의 SLA timeout 카운트 방식</h3>
<p><img src="../../../../../images/airflow/SLA_timeout_count2.PNG" class="img-fluid"></p>
<ul>
<li>실제 airflow에서는 수행 시간을 dag의 최초 실행시점 부터 카운트 하기 시작함</li>
<li>task1의 수행완료 상태 및 시점과 상관없이 task2와 task3의 수행 시간은 task1 수행 시점 부터 카운트 되기 시작한다.</li>
<li>그러므로 task2, task3는 수행된적이 없음에도 miss sla 상태로 처리됨</li>
</ul>
</section>
</div>
</div>
<ul>
<li>2번째 제약사항: DAG의 시작시간 기준 <span class="math inline">\(\rightarrow\)</span> 명목적인 시작 시간 (data_interval_start)
<ul>
<li>위의 SLA timeout 카운트 시작은 dag의 시작시간 기준이라는 제약 사항과 연결되는 제약사항</li>
<li>만약 Pool 이 부족하거나 스케줄러의 부하로 인해 DAG 이 스케줄보다 늦게 시작했다면 늦게 시작한만큼 이미 SLA 시간 카운트는 진행되어 시간이 소요되고 있음
<ul>
<li>실질적 DAG 시작 시간을 기준으로 카운트하지 않음</li>
</ul></li>
<li>즉, 특정 task 수행에 computing 부하가 걸리면 후차적인 task들은 모두 miss 처리됨</li>
<li>대규모 프로젝트에서 흔히 발생하는 문제로 dag이 밀리는 현상이 자주 관찰되므로 sla는 자주쓰이는 방식은 아님.</li>
</ul></li>
<li>3번째 제약사항: 첫 스케줄에서는 SLA Miss 가 기록되지 않음 (두 번째 스케줄부터 기록)</li>
<li>4번째 제약사항: sla miss처리가 분명히 발생됐는데 가끔 기록이 안될때가 있고 email역시 발송이 되지 않을때가 있음. 엄격이 관리가 되지 않는 기능</li>
</ul>
</section>
<section id="full-dag-example" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="full-dag-example"><span class="header-section-number">4.3</span> Full Dag Example</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>from airflow import DAG</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>from airflow.operators.bash import BashOperator</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>from datetime import timedelta</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>import pendulum</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>from airflow.models import Variable</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>email_str = Variable.get("email_target")</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>email_lst = <span class="co">[</span><span class="ot">email.strip() for email in email_str.split(',')</span><span class="co">]</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>with DAG(</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    dag_id='dags_sla_email_example',</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    start_date=pendulum.datetime(2023, 5, 1, tz='Asia/Seoul'),</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    schedule='*/10 * * * *',</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    catchup=False,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    default_args={</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        'sla': timedelta(seconds=70),</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        'email': email_lst</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>) as dag:</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="in">    # 30초 sleep</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="in">    task_slp_30s_sla_70s = BashOperator( </span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_slp_30s_sla_70s',</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 30'</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="in">    # 60초 sleep</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="in">    task_slp_60_sla_70s = BashOperator(</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_slp_60_sla_70s',</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 60'</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="in">    # 10초 sleep</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="in">    task_slp_10s_sla_70s = BashOperator( </span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_slp_10s_sla_70s',</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 10'</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="in">    # 10초 sleep</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="in">    # sla의 timedelta를 명시적으로 30초 선언</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="in">    # default argument보다 명시적 선언이 우선 순위가 더 높음</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="in">    # 그래서, 처음 3개의 task는 timedelta가 70초로 설정됐고 4번째 task는 30초로 설정됨 </span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="in">    task_slp_10s_sla_30s = BashOperator( </span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_slp_10s_sla_30s',</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 10',</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a><span class="in">        sla=timedelta(seconds=30)</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="in">    task_slp_30s_sla_70s &gt;&gt; task_slp_60_sla_70s &gt;&gt; task_slp_10s_sla_70s &gt;&gt; task_slp_10s_sla_30s</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>위 코드를 보면,
<ul>
<li>1번째 task는 30초 sleep이 70초 sla timedelta보다 짧기 때문에 성공 처리</li>
<li>2번째 task는 30,40초 돌다가 miss 처리됨</li>
<li>3,4 번째 task는 수행되기도 전에 miss처리됨</li>
<li>4번째 timedelta가장 짧기 때문에 가장 먼저 miss 처리 됨</li>
</ul></li>
<li>Airflow web service에서 SLA Miss 현황 조회하기
<ul>
<li>airflow web service &gt;&gt; browse</li>
</ul></li>
</ul>
</section>
<section id="sla-miss-시-email-발송하기" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="sla-miss-시-email-발송하기"><span class="header-section-number">4.4</span> SLA Miss 시 email 발송하기</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>from airflow import DAG</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>from airflow.operators.bash import BashOperator</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>from datetime import timedelta</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>import pendulum</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>from airflow.models import Variable</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>email_str = Variable.get("email_target")</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>email_lst = <span class="co">[</span><span class="ot">email.strip() for email in email_str.split(',')</span><span class="co">]</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>with DAG(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    dag_id='dags_sla_email_example',</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    start_date=pendulum.datetime(2023, 5, 1, tz='Asia/Seoul'),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    schedule='*/10 * * * *',</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    catchup=False,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    default_args={</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        'sla': timedelta(seconds=70),</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        'email': email_lst</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>) as dag:</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="in">    task_slp_30s_sla_70s = BashOperator(</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_slp_30s_sla_70s',</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 30'</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="in">    task_slp_60_sla_70s = BashOperator(</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_slp_60_sla_70s',</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 60'</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="in">    task_slp_10s_sla_70s = BashOperator(</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_slp_10s_sla_70s',</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 10'</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="in">    task_slp_10s_sla_30s = BashOperator(</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='task_slp_10s_sla_30s',</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 10',</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="in">        sla=timedelta(seconds=30)</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="in">    task_slp_30s_sla_70s &gt;&gt; task_slp_60_sla_70s &gt;&gt; task_slp_10s_sla_70s &gt;&gt; task_slp_10s_sla_30s</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="timeout-설정하기" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> timeout 설정하기</h1>
<section id="timeout-파라미터-이해" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="timeout-파라미터-이해"><span class="header-section-number">5.1</span> Timeout 파라미터 이해</h2>
<ul>
<li>Task수준의 timeout 과 DAG 수준의 timeout 이 존재</li>
<li>execution_timeout: <a href="https://airflow.apache.org/docs/apache-airflow/stable/_modules/airflow/models/baseoperator.html#BaseOperator">Task수준의 timeout 파라미터: baseOperator 명세에서 <strong>init</strong> 생성자에서 sla 파라미터 아래에 있음</a>
<ul>
<li>execution_timeout: timedelta | None = DEFAULT_TASK_EXECUTION_TIMEOUT,</li>
<li>timedelta보다 오래 task가 수행됐을 때 task는 fail 처리됨</li>
<li>task가 fialure 됐을 때 <strong>init</strong> 생성자 안의 다른 파라미터인 <code>email_on_failure: bool = conf.getboolean("email", "default_email_on_failure", fallback=True)</code> 과 <code>email: str | Iterable[str] | None = None,</code> 에 의해 지정 대상에게 email을 보낼 수 있다.</li>
<li>요약하면, timedelta, email_on_failure, email 이렇게 3개의 파라미터를 이용하여 timedelta 를 초과하는 task 수행시 fail 처리를 하여 이메일을 보낼 수 있다.</li>
</ul></li>
<li>dagrun_timeout: <a href="https://airflow.apache.org/docs/apache-airflow/stable/_modules/airflow/models/dag.html">DAG수준에서도 timeout 파라미터를 걸 수 도 있음</a> : dagrun_timeout
<ul>
<li>[docs]class DAG(LoggingMixin): 의 <strong>init</strong> 생성자</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    def __init__(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>      self,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>      dag_id: str,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      description: str | None = None,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      schedule: ScheduleArg = NOTSET,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      schedule_interval: ScheduleIntervalArg = NOTSET,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>      timetable: Timetable | None = None,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>      start_date: datetime | None = None,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      end_date: datetime | None = None,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>      full_filepath: str | None = None,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      template_searchpath: str | Iterable<span class="co">[</span><span class="ot">str</span><span class="co">]</span> | None = None,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      template_undefined: type<span class="co">[</span><span class="ot">jinja2.StrictUndefined</span><span class="co">]</span> = jinja2.StrictUndefined,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      user_defined_macros: dict | None = None,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>      user_defined_filters: dict | None = None,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      default_args: dict | None = None,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>      concurrency: int | None = None,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      max_active_tasks: int = airflow_conf.getint("core", "max_active_tasks_per_dag"),</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      max_active_runs: int = airflow_conf.getint("core", "max_active_runs_per_dag"),</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>      dagrun_timeout: timedelta | None = None,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      sla_miss_callback: None | SLAMissCallback | list<span class="co">[</span><span class="ot">SLAMissCallback</span><span class="co">]</span> = None,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>      default_view: str = airflow_conf.get_mandatory_value("webserver", "dag_default_view").lower(),</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>      orientation: str = airflow_conf.get_mandatory_value("webserver", "dag_orientation"),</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>      catchup: bool = airflow_conf.getboolean("scheduler", "catchup_by_default"),</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>      on_success_callback: None | DagStateChangeCallback | list<span class="co">[</span><span class="ot">DagStateChangeCallback</span><span class="co">]</span> = None,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>      on_failure_callback: None | DagStateChangeCallback | list<span class="co">[</span><span class="ot">DagStateChangeCallback</span><span class="co">]</span> = None,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>      doc_md: str | None = None,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>      params: collections.abc.MutableMapping | None = None,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>      access_control: dict | None = None,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>      is_paused_upon_creation: bool | None = None,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>      jinja_environment_kwargs: dict | None = None,</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>      render_template_as_native_obj: bool = False,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>      tags: list<span class="co">[</span><span class="ot">str</span><span class="co">]</span> | None = None,</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>      owner_links: dict<span class="co">[</span><span class="ot">str, str</span><span class="co">]</span> | None = None,</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>      auto_register: bool = True,</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  ):</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>다음 파라미터를 이용하여 dag을 관리할 수 있다.
<ul>
<li>schedule: ScheduleArg = NOTSET,</li>
<li>start_date: datetime | None = None,</li>
<li>default_args: dict | None = None,</li>
<li>dagrun_timeout: timedelta | None = None,</li>
</ul></li>
</ul></li>
<li>task1 &gt;&gt; task2 &gt;&gt; task3 예시</li>
</ul>
<div class="columns">
<div class="column" style="width:50%;">
<section id="execution_timeout" class="level3" data-number="5.1.1">
<h3 data-number="5.1.1" class="anchored" data-anchor-id="execution_timeout"><span class="header-section-number">5.1.1</span> execution_timeout</h3>
<ul>
<li>dag은 timeout이 안됐지만 task가 timeout이 되는 case</li>
</ul>
<p><img src="../../../../../images/airflow/execution_timeout1.PNG" class="img-fluid"></p>
<ul>
<li>task2의 실행시간이 task2의 execution_timeout보다 길게 수행되어 fail되었고 task3은 task2로 인해 upstream failed 이 발생</li>
<li>하지만, task1,2,3 의 수행시간의 총합이 dagrun_timeout 보다 짧기 때문에 dag 자체는 실패처리 안됨</li>
</ul>
</section>
</div><div class="column" style="width:50%;">
<section id="datgrun_timeout" class="level3" data-number="5.1.2">
<h3 data-number="5.1.2" class="anchored" data-anchor-id="datgrun_timeout"><span class="header-section-number">5.1.2</span> datgrun_timeout</h3>
<ul>
<li>task는 성공 처리 됐지만 dag이 오랜시간동안 돌아 timeout되어 실패처리되는 case</li>
</ul>
<p><img src="../../../../../images/airflow/dagrun_timeout.PNG" class="img-fluid"></p>
<ul>
<li>각 task들이 execution_timeout보다 짧아 모두 정상 처리 되었지만 task1,2,3의 총 실행시간이 dagrun_timeout보다 길어 dag자체는 failure이 된 상황</li>
<li>dag이 failure되는 시점에서의 task는 skipped 상태로 처리된다.</li>
</ul>
</section>
</div>
</div>
</section>
<section id="dag-full-example" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="dag-full-example"><span class="header-section-number">5.2</span> Dag Full Example</h2>
<ul>
<li>case1: tasks는 실패, dargrun 정상</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Package Import</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>from airflow import DAG</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>from airflow.operators.bash import BashOperator</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>import pendulum</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>from datetime import timedelta</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>from airflow.models import Variable</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu"># email 수신자 리스트</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>email_str = Variable.get("email_target") </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>email_lst = <span class="co">[</span><span class="ot">email.strip() for email in email_str.split(',')</span><span class="co">]</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>with DAG(</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    dag_id='dags_timeout_example_1',</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    start_date=pendulum.datetime(2023, 5, 1, tz='Asia/Seoul'),</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    catchup=False,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    schedule=None,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    dagrun_timeout=timedelta(minutes=1),</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    default_args={</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        #각 task들이 20초안에 끝나야 성공 처리됨</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        'execution_timeout': timedelta(seconds=20), </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        'email_on_failure': True,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        'email': email_lst</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>) as dag:</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    # execution_timeout보다 길기 때문에 task는 실패 처리됨</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    bash_sleep_30 = BashOperator(</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        task_id='bash_sleep_30', </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        bash_command='sleep 30',</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    # execution_timeout보다 짧기 때문에 task는 성공 처리됨</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    bash_sleep_10 = BashOperator(</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        trigger_rule='all_done', # upstream fail에도 task 실행시키기 위해 triggering</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        task_id='bash_sleep_10',</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        bash_command='sleep 10',</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="in">    # upstream failure 발생해도 trigger_rule을 all_done을 줬기 때문에 bash_sleep_10 은 실행됨</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="in">    # dagrun_timeout을 1분으로 설정했기 때문에 task run의 총합이 40초이기 때문에 dagrun은 정상 처리됨</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="in">    bash_sleep_30 &gt;&gt; bash_sleep_10 </span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>case2: tasks는 정상, dargrun 실패</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>from airflow import DAG</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>from airflow.operators.bash import BashOperator</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>import pendulum</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>from datetime import timedelta</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>from airflow.models import Variable</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>email_str = Variable.get("email_target")</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>email_lst = <span class="co">[</span><span class="ot">email.strip() for email in email_str.split(',')</span><span class="co">]</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>with DAG(</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    dag_id='dags_timeout_example_2',</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    start_date=pendulum.datetime(2023, 5, 1, tz='Asia/Seoul'),</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    catchup=False,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    schedule=None,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    dagrun_timeout=timedelta(minutes=1),</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    default_args={</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        'execution_timeout': timedelta(seconds=40),</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        'email_on_failure': True,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        'email': email_lst</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>) as dag:</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    bash_sleep_35 = BashOperator(</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        task_id='bash_sleep_35',</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        bash_command='sleep 35',</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="in">    bash_sleep_36 = BashOperator(</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="in">        trigger_rule='all_done',</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='bash_sleep_36',</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='sleep 36',</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="in">    bash_go = BashOperator(</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="in">        task_id='bash_go',</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="in">        bash_command='exit 0',</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="fu"># 모든 task들이 40초안에 실행완료가 되기때문에 성공 처리됨</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="fu"># dagrun은 1분으로 설정됐기 때문에 2번째 task 가 실행될 때 dag이 fail되고</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="fu"># 2번째task는 skipped 처리가 됨, 이 task에 대해서는 email도 안감 </span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3번째 task는  no status 처리됨 , 이 task에 대해서는 email도 안감</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    bash_sleep_35 &gt;&gt; bash_sleep_36 &gt;&gt; bash_go</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>dagrun_timeout의 한계점
<ul>
<li>모든 task들이 40초안에 실행완료가 되기때문에 성공 처리됨</li>
<li>dagrun은 1분으로 설정됐기 때문에 2번째 task 가 실행될 때 dag이 fail되고</li>
<li>2번째task는 skipped 처리가 됨, 이 task에 대해서는 email도 안감</li>
<li>3번째 task는 no status 처리됨 , 이 task에 대해서는 email도 안감</li>
</ul></li>
</ul>
</section>
<section id="정리-1" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="정리-1"><span class="header-section-number">5.3</span> 정리</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Comparision</th>
<th>sla</th>
<th>execution_timeout</th>
<th>dagrun_timeout</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>파라미터 정의 위치</td>
<td>BaseOperator</td>
<td>BaseOperator</td>
<td>DAG</td>
</tr>
<tr class="even">
<td>적용 수준</td>
<td>Task</td>
<td>task</td>
<td>DAG</td>
</tr>
<tr class="odd">
<td>기능</td>
<td>지정한 시간 초과시 Miss 기록</td>
<td>지정한 시간 초과시 task fail 처리</td>
<td>지정한 시간 초과시 DAG fail 처리</td>
</tr>
<tr class="even">
<td>email 발송 가능 여부</td>
<td>O</td>
<td>O</td>
<td>X</td>
</tr>
<tr class="odd">
<td>timeout 발생시 후행 task 상태</td>
<td>상관없이 지속</td>
<td>Upstream_failed</td>
<td>Skipped (current) /No status (not run)</td>
</tr>
<tr class="even">
<td>스케쥴 필요</td>
<td>O</td>
<td>X</td>
<td>X</td>
</tr>
</tbody>
</table>
<ul>
<li>sla, execution_timeout에는 email 발송 paraemeter가 있지만 execution_timeout에는 없다.</li>
<li>dagrun timeout이 fail 됐을 때 반드시 email 발송 하고싶으면 dag의 파라미터 중 on_failure_callback 에 dag이 실패됐을 때 이메일을 전송하는 함수를 만들어 그 함수명을 할당해준다.</li>
<li>upstream_failed 상태는 execution_timeout만이 갖는 특징이 아니라 airflow의 디폴트 설정이다. 상위 task들이 fail되면 후행 task들은 upstream_failed로 남는다.</li>
<li>공통점: 파이썬의 timedelta 함수로 timeout 기준 시간 정의</li>
</ul>
</section>
</section>
<section id="airflow-cli-사용하기" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Airflow CLI 사용하기</h1>
<ul>
<li>Airflow가 설치되어 있는 서버 또는 환경에서 shell 명령을 이용하여 Airflow를 컨트롤 할 수 있도록 많은 기능들을 제공하고 있음</li>
<li><a href="https://airflow.apache.org/docs/apache-airflow/stable/cli-and-env-variables-ref.html">airflow cli doc</a>
<ul>
<li>대표적인 content
<ul>
<li>dags: dag을 다룰 수 잇는 커맨드
<ul>
<li><code>airflow dags [-h] COMMAND ...</code></li>
<li>backfill: airflow web ui 의 grid 기능을 보면 dag이 돌았던 이력을 볼 수 있는데 grid 상 가장 과거 날짜 뿐만 아니라 그 이전의 과거 날짜 또한 command의 옵션으로 모두 돌릴 수 있음</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>  airflow dags backfill <span class="co">[</span><span class="ot">-h</span><span class="co">] [-c CONF]</span> <span class="co">[</span><span class="ot">--continue-on-failures</span><span class="co">]</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                <span class="co">[</span><span class="ot">--delay-on-limit DELAY_ON_LIMIT</span><span class="co">] [--disable-retry]</span> <span class="co">[</span><span class="ot">-x</span><span class="co">]</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                <span class="co">[</span><span class="ot">-n</span><span class="co">] [-e END_DATE]</span> <span class="co">[</span><span class="ot">-i</span><span class="co">] [-I]</span> <span class="co">[</span><span class="ot">-l</span><span class="co">] [-m]</span> <span class="co">[</span><span class="ot">--pool POOL</span><span class="co">]</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                <span class="co">[</span><span class="ot">--rerun-failed-tasks</span><span class="co">] [--reset-dagruns]</span> <span class="co">[</span><span class="ot">-B</span><span class="co">]</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                <span class="co">[</span><span class="ot">-s START_DATE</span><span class="co">] [-S SUBDIR]</span> <span class="co">[</span><span class="ot">-t TASK_REGEX</span><span class="co">]</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                <span class="co">[</span><span class="ot">--treat-dag-as-regex</span><span class="co">] [-v]</span> <span class="co">[</span><span class="ot">-y</span><span class="co">]</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                dag_id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>delete: Delete all DB records related to the specified DAG</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>airflow dags delete <span class="co">[</span><span class="ot">-h</span><span class="co">] [-v]</span> <span class="co">[</span><span class="ot">-y</span><span class="co">]</span> dag_id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>details: Get DAG details given a DAG id</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>airflow dags details <span class="co">[</span><span class="ot">-h</span><span class="co">] [-o table, json, yaml, plain]</span> <span class="co">[</span><span class="ot">-v</span><span class="co">]</span> dag_id</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>list: List all the DAGs</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="in">```markdown</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>airflow dags list <span class="co">[</span><span class="ot">-h</span><span class="co">] [-o table, json, yaml, plain]</span> <span class="co">[</span><span class="ot">-S SUBDIR</span><span class="co">] [-v]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li>variables: variables을 관리하는 command
<ul>
<li><code>airflow variables [-h] COMMAND ...</code></li>
<li>delete: <code>airflow variables delete [-h] [-v] key</code>
<ul>
<li>등록되있는 variables을 key값을 입력하여 삭제</li>
</ul></li>
<li>export: <code>airflow variables export [-h] [-v] file</code>
<ul>
<li>등록되있는 variables을 json file로 추출</li>
</ul></li>
<li>get: <code>airflow variables get [-h] [-d VAL] [-j] [-v] key</code>
<ul>
<li>특정 variables의 key값을 주어 values을 꺼내옴</li>
</ul></li>
<li>import: <code>airflow variables import [-h] [-v] file</code>
<ul>
<li>json file에 variables을 작성해놓고 list를 한번에 입력한다.</li>
</ul></li>
<li>list: <code>airflow variables list [-h] [-o table, json, yaml, plain] [-v]</code></li>
<li>set: <code>airflow variables set [-h] [-j] [-v] key VALUE</code></li>
</ul></li>
</ul></li>
</ul></li>
<li>Cli를 잘 쓰면 좋은 이유
<ul>
<li>일괄작업: Airflow UI에서 할 수 없는 일괄 작업 방식을 제공
<ul>
<li>ex: connection 일괄 등록. 만약 airflow ui로 등록하면 일일히 등록해야한다.</li>
<li>물론 CLI를 이용하는 방법 외에 metaDB table에 직접 insert하는 방법도 있음</li>
</ul></li>
<li>특수기능: Airflow UI에서는 할 수 없는 기능을 제공
<ul>
<li>ex: backfill 은 airflow ui 를 통해서는 실행 불가</li>
</ul></li>
<li>자동화: Airflow UI에서 직접 눈으로 보고 클릭하는 방식이 아닌 프로그래밍에 의한 제어가 가능해짐
<ul>
<li>CLI 커맨드는 shell 명령어로 이루저있기 때문에 shell script를 작성하여 자동화 할 수 있다.</li>
</ul></li>
</ul></li>
</ul>
<section id="cli---dag-trigger" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="cli---dag-trigger"><span class="header-section-number">6.1</span> cli - dag trigger</h2>
<ul>
<li><p>dag trigger: airflow ui 상에서 manual 로 dag trigger 하거나 run_id 를 직접 넣어 trigger 할 수 있는 기능으로 CLI로 실행시킬 수 있다.</p></li>
<li><p>CLI 명령은 WSL2에서 하는게 아니라 docker container안에서 해야함</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>airflow dags trigger <span class="co">[</span><span class="ot">-h</span><span class="co">] [-c CONF]</span> <span class="co">[</span><span class="ot">-e EXEC_DATE</span><span class="co">]</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                     <span class="co">[</span><span class="ot">--no-replace-microseconds</span><span class="co">] [-o table, json, yaml, plain]</span> <span class="co">[</span><span class="ot">-r RUN_ID</span><span class="co">] [-S SUBDIR]</span> <span class="co">[</span><span class="ot">-v</span><span class="co">]</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                   dag_id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>EXEC_DATE: execution_date parameter는 모두 data_interval_start 기준이며 String 형식으로 입력하면 기본 UTC로 계산됨</li>
<li>RUN_ID를 입력하면 기본적으로 manual__로 시작하며 run_id를 직접 입력도 가능</li>
<li>예시: <code>#&gt; airflow dags trigger dags_seoul_api_corona</code></li>
</ul></li>
<li><p>Full Example</p></li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># docker container list 확인</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>sudo docker ps </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu"># webserver container 선택 (어떤 것을 골라도 상관없음)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># airflow container 들어가기: sudo docker exec -it [docker_container_id] bash</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>sudo docker exec -it 8b755cb5aa70 bash </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="fu"># trigger 명령어 실행</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>airflow dags trigger dags_base_branch_operator</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="결과" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="결과"><span class="header-section-number">6.2</span> 결과</h2>
<p><img src="../../../../../images/airflow/cli_example_1.PNG" class="img-fluid"></p>
<ul>
<li>dag_run_id: manual__2023-07-22T05:05:59+00:00.</li>
<li>run type: manual__
<ul>
<li>ClI 로 돌렸기 때문에 manual_이 붙어있음</li>
<li>run types: schedule, manual, backfill 등이 있음</li>
</ul></li>
</ul>
</section>
<section id="cli---dag-backfill" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="cli---dag-backfill"><span class="header-section-number">6.3</span> cli - dag backfill</h2>
<ul>
<li>입력 스케줄 구간에 대해 일괄 (재)실행 (스케줄 이력이 없는 과거 날짜도 가능)</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># start (-s), end(-ㄷ) 파라미터를 dashed string 형태로 입력하면 UTC로 간주(아래의 start 날짜에 시간:분:초가 나와있지 않지만 날짜뒤에 00:00:00 가 붙음) </span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>airflow dags backfill -s 2023-04-19 -e 2023-04-21 dags_seoul_api_corona</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu"># 타임스탬프 형태로 직접 작성도 가능 (run_id에서 해당하는 날짜 구간을 찾아 실행)</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>airflow dags backfill -s 2023-04-19T22:00:00+00:00 -e 2023-04-20T22:00:00+00:00 —reset-dagruns dags_seoul_api_corona</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>위의 예시에서, -s 2023-04-19 -e 2023-04-21 옵션이 있고 grid에서 task 수행 이력의 가장 최근 날짜가 2023-04-21 이라고 가정해보자.
<ul>
<li>run_id가 scheduled__2023-04-21T22:00:00+00:00 일때</li>
<li>위의 날짜 구간 옵션에 있고 dag이 실행되지 않았던 04/20 22:00, 04/19 22:00 2개가 돌아가게 됨</li>
</ul></li>
</ul>
</section>
<section id="cli---task-clear" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="cli---task-clear"><span class="header-section-number">6.4</span> cli - task clear</h2>
<ul>
<li>Clear 작업을 start / end 구간으로 일괄 재실행
<ul>
<li>backfill의 경우 task가 수행이 됐건 안됐건 무조건 실행 (무조건 재실행)</li>
<li>하지만 clear 이미 실행됐던 task에 한해서 재실행됨</li>
<li>Backfill과 달리 수행되지 않은 스케줄 구간은 실행할 수 없음</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>airflow tasks clear <span class="co">[</span><span class="ot">-h</span><span class="co">] [-R]</span> <span class="co">[</span><span class="ot">-d</span><span class="co">] [-e END_DATE]</span> <span class="co">[</span><span class="ot">-X</span><span class="co">] [-x]</span> <span class="co">[</span><span class="ot">-f</span><span class="co">] [-r]</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                    <span class="co">[</span><span class="ot">-s START_DATE</span><span class="co">] [-S SUBDIR]</span> <span class="co">[</span><span class="ot">-t TASK_REGEX</span><span class="co">] [-u]</span> <span class="co">[</span><span class="ot">-v</span><span class="co">] [-y]</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                    dag_id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>airflow tasks clear -s 2023-05-07 -e 2023-05-12 dags_seoul_api_corona</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>airflow tasks clear -s 2023-05-07T22:00:00+00:00 -e 2023-05-12T22:00:00+00:00 dags_seoul_api_corona</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li>Backfill되었던 DAG은 clear 불가함. reset-dagruns 옵션과 함께 다시 Backfill 수행해야 함</li>
</ul>
</section>
<section id="정리-2" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="정리-2"><span class="header-section-number">6.5</span> 정리</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Comparision</th>
<th>trigger</th>
<th>backfill</th>
<th>clear</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>목적</td>
<td>특정 날짜로 DAG Trigger</td>
<td>Start ~ end 구간의 스케줄 실행</td>
<td>Start ~ end 구간 내 이미 수</td>
</tr>
<tr class="even">
<td>행되었던 스케줄 재실행</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Run type</td>
<td>-r 옵션으로 지정 가능. 없으면 Manual</td>
<td>Backfill</td>
<td>원래의 run_type</td>
</tr>
<tr class="even">
<td>기 수행된 run_id가 존재하는 경우</td>
<td>동일 run_id 가 존재하는 경우 에러 발생</td>
<td>Run_type 을 Backfill 로 덮어쓰며</td>
<td></td>
</tr>
<tr class="odd">
<td>재실행</td>
<td>재실행</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>구간 지정</td>
<td>불가</td>
<td>가능</td>
<td>가능</td>
</tr>
<tr class="odd">
<td>과거 날짜 적용 가능</td>
<td>가능</td>
<td>가능</td>
<td>불가</td>
</tr>
<tr class="even">
<td>task 선택 가능</td>
<td>불가</td>
<td>가능</td>
<td>가능</td>
</tr>
</tbody>
</table>
<ul>
<li>공통점: CLI 명령으로 DAG 실행 가능</li>
</ul>
</section>
</section>
<section id="triggerer" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Triggerer</h1>
<p>Scheduler, worker, webserver, triggerer containers 중 하나</p>
<section id="airflow-triggerer의-필요성" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="airflow-triggerer의-필요성"><span class="header-section-number">7.1</span> Airflow Triggerer의 필요성</h2>
<ul>
<li>Airflow는 그 자체로 ETL 툴이라기보다 오케스트레이션 솔루션</li>
<li>왜냐면 airflow와 연계되는 외부 솔루션에 작업 제출, 상태 확인, 완료 확인 등의 절차를 통해 관리</li>
<li>예를 들어 airflow의 worker container가 python logic을 직접 처리하는게 아니라 python logic 을 python이 처리하도록 명령을 제출하고 로직 확인 및 결과 확인을 수행한다.</li>
</ul>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 315.68 346.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 342)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-342 311.68,-342 311.68,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster0</title>
<polygon fill="none" stroke="black" points="8,-8 8,-330 299.68,-330 299.68,-8 8,-8"></polygon>
</g>
<!-- airflow -->
<g id="node1" class="node">
<title>airflow</title>
<ellipse fill="none" stroke="black" cx="54.92" cy="-168" rx="38.85" ry="38.85"></ellipse>
<text text-anchor="middle" x="54.92" y="-163.8" font-family="Times,serif" font-size="14.00">airflow</text>
</g>
<!-- PostgresqlDB -->
<g id="node2" class="node">
<title>PostgresqlDB</title>
<polygon fill="none" stroke="black" points="291.58,-52 198,-52 198,-16 291.58,-16 291.58,-52"></polygon>
<text text-anchor="middle" x="244.79" y="-29.8" font-family="Times,serif" font-size="14.00">PostgresqlDB</text>
</g>
<!-- airflow&#45;&gt;PostgresqlDB -->
<g id="edge1" class="edge">
<title>airflow-&gt;PostgresqlDB</title>
<path fill="none" stroke="black" d="M74.91,-134.17C84.47,-119.47 97.17,-102.95 111.85,-91.2 134.21,-73.29 163.04,-59.94 188.05,-50.67"></path>
<polygon fill="black" stroke="black" points="189.54,-53.85 197.78,-47.19 187.18,-47.26 189.54,-53.85"></polygon>
<text text-anchor="middle" x="145.87" y="-95.2" font-family="Times,serif" font-size="14.00">작업 실행</text>
</g>
<!-- Hive -->
<g id="node3" class="node">
<title>Hive</title>
<polygon fill="none" stroke="black" points="271.79,-106 217.79,-106 217.79,-70 271.79,-70 271.79,-106"></polygon>
<text text-anchor="middle" x="244.79" y="-83.8" font-family="Times,serif" font-size="14.00">Hive</text>
</g>
<!-- airflow&#45;&gt;Hive -->
<g id="edge2" class="edge">
<title>airflow-&gt;Hive</title>
<path fill="none" stroke="black" d="M90.06,-151.07C97.21,-147.64 104.74,-144.14 111.85,-141 144.08,-126.76 181.4,-111.92 208.1,-101.58"></path>
<polygon fill="black" stroke="black" points="209.71,-104.71 217.79,-97.85 207.2,-98.18 209.71,-104.71"></polygon>
</g>
<!-- HDFS -->
<g id="node4" class="node">
<title>HDFS</title>
<polygon fill="none" stroke="black" points="271.79,-160 217.79,-160 217.79,-124 271.79,-124 271.79,-160"></polygon>
<text text-anchor="middle" x="244.79" y="-137.8" font-family="Times,serif" font-size="14.00">HDFS</text>
</g>
<!-- airflow&#45;&gt;HDFS -->
<g id="edge3" class="edge">
<title>airflow-&gt;HDFS</title>
<path fill="none" stroke="black" d="M92.42,-157.37C98.85,-155.77 105.51,-154.3 111.85,-153.2 143.84,-147.65 180.7,-144.82 207.31,-143.39"></path>
<polygon fill="black" stroke="black" points="207.52,-146.88 217.33,-142.89 207.17,-139.89 207.52,-146.88"></polygon>
<text text-anchor="middle" x="145.87" y="-157.2" font-family="Times,serif" font-size="14.00">작업 실행</text>
</g>
<!-- Bigquerty -->
<g id="node5" class="node">
<title>Bigquerty</title>
<polygon fill="none" stroke="black" points="280.78,-214 208.8,-214 208.8,-178 280.78,-178 280.78,-214"></polygon>
<text text-anchor="middle" x="244.79" y="-191.8" font-family="Times,serif" font-size="14.00">Bigquerty</text>
</g>
<!-- airflow&#45;&gt;Bigquerty -->
<g id="edge4" class="edge">
<title>airflow-&gt;Bigquerty</title>
<path fill="none" stroke="black" d="M93.49,-173.6C123.73,-178.11 166.34,-184.46 198.48,-189.25"></path>
<polygon fill="black" stroke="black" points="198.11,-192.73 208.51,-190.74 199.14,-185.81 198.11,-192.73"></polygon>
<text text-anchor="middle" x="145.87" y="-190.2" font-family="Times,serif" font-size="14.00">완료 확인</text>
</g>
<!-- Python_func -->
<g id="node6" class="node">
<title>Python_func</title>
<polygon fill="none" stroke="black" points="288.34,-268 201.24,-268 201.24,-232 288.34,-232 288.34,-268"></polygon>
<text text-anchor="middle" x="244.79" y="-245.8" font-family="Times,serif" font-size="14.00">Python_func</text>
</g>
<!-- airflow&#45;&gt;Python_func -->
<g id="edge5" class="edge">
<title>airflow-&gt;Python_func</title>
<path fill="none" stroke="black" d="M86.27,-191.56C94.3,-197.12 103.16,-202.67 111.85,-207 136.87,-219.46 166.31,-229.46 191.02,-236.67"></path>
<polygon fill="black" stroke="black" points="190.37,-240.12 200.95,-239.49 192.28,-233.39 190.37,-240.12"></polygon>
<text text-anchor="middle" x="145.87" y="-236.2" font-family="Times,serif" font-size="14.00">Python func</text>
</g>
<!-- Spark -->
<g id="node7" class="node">
<title>Spark</title>
<polygon fill="none" stroke="black" points="271.79,-322 217.79,-322 217.79,-286 271.79,-286 271.79,-322"></polygon>
<text text-anchor="middle" x="244.79" y="-299.8" font-family="Times,serif" font-size="14.00">Spark</text>
</g>
<!-- airflow&#45;&gt;Spark -->
<g id="edge6" class="edge">
<title>airflow-&gt;Spark</title>
<path fill="none" stroke="black" d="M72.53,-203.21C82.03,-220.18 95.35,-239.69 111.85,-253 139.93,-275.66 179.25,-289.11 207.65,-296.46"></path>
<polygon fill="black" stroke="black" points="207.04,-299.91 217.58,-298.89 208.7,-293.11 207.04,-299.91"></polygon>
<text text-anchor="middle" x="145.87" y="-292.2" font-family="Times,serif" font-size="14.00">상태 확인</text>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li>bigquerty: google에 있는 data 저장소 서비스</li>
<li>외부 솔루션에 작업이 제출되어 완료될 때까지 Airflow의 Slot은 점유됨</li>
</ul>
<p><img src="../../../../../images/airflow/triggerer.PNG" class="img-fluid"> * airflow 의 task가 들어왔을 때 task는 airflow worker의 slot을 차지하게 됨 * 후에, 작업 대상에 작업을 제출하고 작업이 시작된다 * 작업대상: python function 또는 postgres, HDFS, Spark와 같은 외부 솔루션 * 작업이 진행되면 airflow는 작업이 완료 되었는지 작업상태를 polling 하면서 지속적으로 체크 * 작업 처리가 진행되는 동안 task는 차지했던 worker의 slot을 게속해서 차지한다. * task가 많아지면 airflow의 slot이 부족할 수도 있는 상황이 있음 * 그럼 작업 처리동안 task는 slot 점유할 필요는 없지 않나라는 생각이 들 수 있다. * triggerer가 이 문제를 해결 * 작업을 제출하고 Task는 작업 처리가 시작될 때 Slot을 비우고 작업 상태 Polling 작업은 Triggerer 에게 위임 * 작업 처리 시작 전까지는 slot을 점유 * 작업상태를 끊임없이 polling하면서 확인해야하는데 triggerer를 이용하면 이 작업이 없어짐 * triggerer는 작업 처리 완료가 되는 event (작업 완료 callback message를 수신)를 받아 scheduluer container에게 message를 전달하고 scheduler는 task가 다시 비워진 slot을 점유하게 한다.</p>
<p><img src="../../../../../images/airflow/triggerer2.PNG" class="img-fluid"></p>
</section>
<section id="triggerer란" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="triggerer란"><span class="header-section-number">7.2</span> Triggerer란</h2>
<ul>
<li>워커를 대신하여 작업 상태 완료를 수신하고, 그때까지 Slot을 비워둘 수 있도록 해주는 Airflow의 서비스
<ul>
<li>airflow service: 스케줄러, 워커 같은 요소 중 하나</li>
</ul></li>
<li>Python의 비동기 작업 라이브러리인 asyncio를 이용하여 작업상태 수신
<ul>
<li>사용 조건: Airflow 2.2 부터 &amp; Python 3.7부터 사용 가능</li>
</ul></li>
<li>어떻게 사용하나?
<ul>
<li>Deferrable Operator 이용하여 Task 생성</li>
<li>기본 Operator 중에서는 아래의 Sensor 종류만 사용 가능
<ul>
<li>TimeSensorAsync</li>
<li>DateTimeSensorAsync</li>
<li>TimeDeltaSensorAsync</li>
</ul></li>
<li>끝에 Async 가 붙은 오퍼레이터를 Deferrable Operator라 부르며 Triggerer에게 작업 완료 수신을 맡기는 오퍼레이터라는 의미</li>
</ul></li>
</ul>
</section>
<section id="triggerer-실습" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="triggerer-실습"><span class="header-section-number">7.3</span> Triggerer 실습</h2>
<p>비교 실험</p>
<ul>
<li>dags/dags_time_sensor.py (함수를 그냥 짬)</li>
<li>dags/dags_time_sensor_with_async.py (asyncio library 이용)</li>
</ul>
</section>
<section id="dag-full-example-1" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="dag-full-example-1"><span class="header-section-number">7.4</span> Dag Full Example</h2>
<ul>
<li>dag_time_sensor.py</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>import pendulum</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>from airflow import DAG</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>from airflow.sensors.date_time import DateTimeSensor</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>with DAG(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    dag_id="dags_time_sensor",</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    # 1시간 차이</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    start_date=pendulum.datetime(2023, 5, 1, 0, 0, 0), #5월1일 0시</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    end_date=pendulum.datetime(2023, 5, 1, 1, 0, 0), #5월1일 1시</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    schedule="*/10 * * * *", #10 분마다 1시간안에 7번 돌게함</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    # 00분, 10분, 20분, 30분, 40분, 50분, 60분 총 7번</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    catchup=True, # catchup을 true이기 때문에 작업 상태bar 7개가 동시에 뜸</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    # airflow ui의 작업 pool을 보면 시작할 때 7개를 모두 차지 하도록 나옴</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>) as dag:</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    # DateTimeSensor는 목표로 하는 시간까지 기다리는 sensor</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    sync_sensor = DateTimeSensor(</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        task_id="sync_sensor",</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        # 현재 시간 + 5분</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        target_time="""{{ macros.datetime.utcnow() + macros.timedelta(minutes=5) }}""",</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>dags_time_sensor_with_async.py</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>import pendulum</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>from airflow import DAG</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>from airflow.sensors.date_time import DateTimeSensorAsync</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>with DAG(</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    dag_id="dags_time_sensor_with_async",</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    start_date=pendulum.datetime(2023, 5, 1, 0, 0, 0),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    end_date=pendulum.datetime(2023, 5, 1, 1, 0, 0),</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    schedule="*/10 * * * *",</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    catchup=True,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>) as dag:</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    sync_sensor = DateTimeSensorAsync(</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        task_id="sync_sensor",</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        target_time="""{{ macros.datetime.utcnow() + macros.timedelta(minutes=5) }}""",</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>airflow ui&gt;&gt; browse &gt;&gt; triggers 에서 trigger가 작업하는 대상 목록을 보여줌</li>
<li>trigger는 triggerer에게 작업을 맡길 event 또는 ticket이라고 생각하면 됨</li>
<li>triggerer id는 ticket id</li>
<li>defered status 는 보라색을 띄고 이 상태에서는 worker slot을 차지 않는 상태이다.</li>
</ul>
</section>
<section id="요약" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="요약"><span class="header-section-number">7.5</span> 요약</h2>
<ul>
<li>끝에 Async가 붙은 오퍼레이터는 Deferrable Operator 라 부르며 Triggerer에 의해 Polling이 수행되는 오퍼레이터임을 의미</li>
<li>Deferrable Operator는 작업 제출 후 Slot을 차지하지 않으며 Polling 내역에 대해 Trigger 제출 후 deferred 상태가 됨.</li>
<li>Triggerer는 제출된 Trigger 내역을 보고 작업 완료시(조건 만족시) Worker에게 알려줘 작업이 마무리될 수 있도록 함.</li>
</ul>
</section>
</section>
</div>
<div id="English" class="tab-pane fade" role="tabpanel" aria-labelledby="English-tab">

</div>


</div>

</ul></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("kmink3225\.netlify\.app");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="./docs/comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->




</body></html>